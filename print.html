<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Blog by lichuan</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">React</li><li class="chapter-item expanded affix "><li class="part-title">Functional Component</li><li class="chapter-item expanded "><a href="react/chartjs/render-all-chartjs-charts.html"><strong aria-hidden="true">1.</strong> Render all chartjs charts in react typescript tailwindcss projects</a></li><li class="chapter-item expanded affix "><li class="part-title">React Query</li><li class="chapter-item expanded "><a href="react-query/setup-tanstack-react-query-in-nextjs-project.html"><strong aria-hidden="true">2.</strong> Setup Tanstack React Query in NextJS Project</a></li><li class="chapter-item expanded affix "><li class="part-title">Gitlab</li><li class="chapter-item expanded "><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html"><strong aria-hidden="true">3.</strong> Register gitlab runner on Amazon Linux 2</a></li><li class="chapter-item expanded affix "><li class="part-title">Rust</li><li class="chapter-item expanded "><a href="rust/error/how-to-organise-application-error-in-actix-web-application.html"><strong aria-hidden="true">4.</strong> How to organise application Error in actix-web application</a></li><li class="chapter-item expanded "><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html"><strong aria-hidden="true">5.</strong> Serialize time::OffsetDataTime type using serde_as in serde_with crate</a></li><li class="chapter-item expanded "><a href="rust/diesel/upgrade-diesel-to-2.0.html"><strong aria-hidden="true">6.</strong> Upgrade diesel to 2.0</a></li><li class="chapter-item expanded affix "><li class="part-title">Go</li><li class="chapter-item expanded "><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html"><strong aria-hidden="true">7.</strong> Add dependency in go mod in self-hosted gitlab</a></li><li class="chapter-item expanded affix "><li class="part-title">NextJS</li><li class="chapter-item expanded "><a href="nextjs/add-nextjs-router-to-mui-tabs.html"><strong aria-hidden="true">8.</strong> Add nextjs router to mui tabs</a></li><li class="chapter-item expanded affix "><li class="part-title">NodeJS</li><li class="chapter-item expanded "><a href="nodejs/test/setup-tests-in-npm-project-using-jest.html"><strong aria-hidden="true">9.</strong> Setup tests in npm project using jest</a></li><li class="chapter-item expanded affix "><li class="part-title">ClickHouse</li><li class="chapter-item expanded "><a href="clickhouse/update/update-on-local-table-for-replicatedmergetree-table-engine.html"><strong aria-hidden="true">10.</strong> Update on local table for ReplicatedMergeTree Table Engine</a></li><li class="chapter-item expanded affix "><li class="part-title">Elasticsearch</li><li class="chapter-item expanded "><a href="elasticsearch/kibana/existing-value-not-exists-when-searching.html"><strong aria-hidden="true">11.</strong> Existing value not exists when searching</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Blog by lichuan</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="render-all-chartjs-charts-in-react-typescript-tailwindcss-projects"><a class="header" href="#render-all-chartjs-charts-in-react-typescript-tailwindcss-projects">Render all chartjs charts in react typescript tailwindcss projects</a></h1>
<p>In this tutorial, we'll show you how to render all chartjs charts in React project.</p>
<h1 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h1>
<!--ts-->
<ul>
<li><a href="react/chartjs/render-all-chartjs-charts.html#render-all-chartjs-charts-in-react-typescript-tailwindcss-projects">Render all chartjs charts in react typescript tailwindcss projects</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#table-of-contents">Table of Contents</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#demoseeing-is-believing">Demo(seeing is believing)</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#start-nextjs-project">Start NextJS Project</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#define-all-chartjs-charts">Define all chartjs charts</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#write-a-functional-component">Write a functional component</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#write-a-chartjs-wrapper">Write a chartjs wrapper</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#layout">Layout</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#optimize">Optimize</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#summary">Summary</a></li>
</ul>
<!--te-->
<h1 id="demoseeing-is-believing"><a class="header" href="#demoseeing-is-believing">Demo(seeing is believing)</a></h1>
<p>Before diving in, we will show you all charts I created.</p>
<p><img src="https://user-images.githubusercontent.com/74223747/224673738-9edb7c6d-5e49-44a2-9bb0-00fa9eb5f608.png" alt="chartjs-react-chartjs-2-nextjs-tailwind-typescript-using-grid" /></p>
<h1 id="start-nextjs-project"><a class="header" href="#start-nextjs-project">Start NextJS Project</a></h1>
<p>First, we'll create a nextjs + tailwind + typescript project using <code>npx</code>:</p>
<pre><code class="language-bash">npx create-next-app@latest react-chartjs-2-nextjs-tailwind-example --typescript --eslint

cd react-chartjs-2-nextjs-tailwind-example
npm install -D tailwindcss postcss autoprefixer
npx tailwindcss init -p
</code></pre>
<h1 id="define-all-chartjs-charts"><a class="header" href="#define-all-chartjs-charts">Define all chartjs charts</a></h1>
<p>We copy all chartjs official example codes and put them in <code>component/chartjsofficial</code> directory. We also define title and component for each example chart. The <code>components</code> array is the chart data we will render later.</p>
<pre><code class="language-jsx">import { VerticalBarChart } from "@/component/chartjsofficial/verticalbarchart";
import { HorizontalBarChart } from "@/component/chartjsofficial/horizontalbarchart";
import { StackedBarChart } from "@/component/chartjsofficial/stackedbarchart";
import { GroupedBarChart } from "@/component/chartjsofficial/groupedbarchart";
import { AreaChart } from "@/component/chartjsofficial/areachart";
import { LineChart } from "@/component/chartjsofficial/linechart";
import { MultiAxisLineChart } from "@/component/chartjsofficial/multiaxislinechart";
import { PieChart } from "@/component/chartjsofficial/piechart";
import { DoughnutChart } from "@/component/chartjsofficial/doughnutchart";
import { PolarAreaChart } from "@/component/chartjsofficial/polarareachart";
import { RadarChart } from "@/component/chartjsofficial/radarchart";
import { ScatterChart } from "@/component/chartjsofficial/scatterchart";
import { BubbleChart } from "@/component/chartjsofficial/bubblechart";
import { MultiTypeChart } from "@/component/chartjsofficial/multitypechart";
import { ChartEvents } from "@/component/chartjsofficial/chartevents";
import { ChartRef } from "@/component/chartjsofficial/chartref";
import { GradientChart } from "@/component/chartjsofficial/gradientchart";
import { ChartEventsSingleDataset } from "@/component/chartjsofficial/charteventssingledataset";
import { ChartEventsSingleDatasetOutsideDatasource } from "@/component/chartjsofficial/charteventssingledatasetoutsidedatasource";

const components = [
  {
    title: "VerticalBarChart",
    component: VerticalBarChart,
  },
  {
    title: "HorizontalBarChart",
    component: HorizontalBarChart,
  },
  {
    title: "StackedBarChart",
    component: StackedBarChart,
  },
  {
    title: "GroupedBarChart",
    component: GroupedBarChart,
  },
  {
    title: "AreaChart",
    component: AreaChart,
  },
  {
    title: "LineChart",
    component: LineChart,
  },
  {
    title: "MultiAxisLineChart",
    component: MultiAxisLineChart,
  },
  {
    title: "DoughnutChart",
    component: DoughnutChart,
  },
  {
    title: "PolarAreaChart",
    component: PolarAreaChart,
  },
  {
    title: "RadarChart",
    component: RadarChart,
  },
  {
    title: "ScatterChart",
    component: ScatterChart,
  },
  {
    title: "BubbleChart",
    component: BubbleChart,
  },
  {
    title: "ScatterChart",
    component: ScatterChart,
  },
  {
    title: "MultiTypeChart",
    component: MultiTypeChart,
  },
  {
    title: "ChartEvents",
    component: ChartEvents,
  },
  {
    title: "ChartRef",
    component: ChartRef,
  },
  {
    title: "GradientChart",
    component: GradientChart,
  },
  {
    title: "ChartEventsSingleDataset",
    component: ChartEventsSingleDataset,
  },
];
</code></pre>
<h1 id="write-a-functional-component"><a class="header" href="#write-a-functional-component">Write a functional component</a></h1>
<p>In order to render all components(charts), we write a functional component called <code>ComponentWrapper</code> to take array of components with title and render them in one place.</p>
<pre><code class="language-jsx">type Component = {
  title: string,
  component: React.FunctionComponent,
};
type ChartProps = {
  components: Component[],
};

const ComponentWrapper: React.FC&lt;ChartProps&gt; = ({ components }) =&gt; {
  return (
    &lt;div&gt;
      {components.map((component, index) =&gt; {
        return (
          &lt;ChartWrapper key={index} title={component.title}&gt;
            &lt;component.component /&gt;
          &lt;/ChartWrapper&gt;
        );
      })}
    &lt;/div&gt;
  );
};
</code></pre>
<p>The <code>ComponentWrapper</code> component maps over the components array and renders each component wrapped in a <code>ChartWrapper</code> component(explained later).</p>
<p>It receives a prop object of type <code>ChartProps</code>, destructures the <code>components</code> property from that object, and uses it to render a list of React function components.</p>
<p>We can refer to the component part from item in <code>components</code> array, i.e. <code>ChartEventsSingleDataset</code></p>
<pre><code class="language-jsx">import React, { MouseEvent, useRef } from "react";
import type { InteractionItem } from "chart.js";
import {
  Chart as ChartJS,
  LinearScale,
  CategoryScale,
  BarElement,
  PointElement,
  LineElement,
  Legend,
  Tooltip,
} from "chart.js";
import {
  Chart,
  getDatasetAtEvent,
  getElementAtEvent,
  getElementsAtEvent,
} from "react-chartjs-2";
import faker from "faker";

ChartJS.register(
  LinearScale,
  CategoryScale,
  BarElement,
  PointElement,
  LineElement,
  Legend,
  Tooltip
);

export const options = {
  scales: {
    y: {
      beginAtZero: true,
    },
  },
};

const labels = ["January", "February", "March", "April", "May", "June", "July"];

export const data = {
  labels,
  datasets: [
    {
      type: "bar" as const,
      label: "Dataset 1",
      borderColor: "rgb(255, 99, 132)",
      backgroundColor: "rgb(255, 99, 132)",
      data: labels.map(() =&gt; faker.datatype.number({ min: -1000, max: 1000 })),
    },
  ],
};

export function ChartEventsSingleDataset() {
  const printDatasetAtEvent = (dataset: InteractionItem[]) =&gt; {
    if (!dataset.length) return;

    const datasetIndex = dataset[0].datasetIndex;

    console.log(`printDatasetAtEvent: ${data.datasets[datasetIndex].label}`);
  };

  const printElementAtEvent = (element: InteractionItem[]) =&gt; {
    if (!element.length) return;

    const { datasetIndex, index } = element[0];

    console.log(
      `index: ${data.labels[index]}, data: ${data.datasets[datasetIndex].data[index]}`
    );
  };

  const printElementsAtEvent = (elements: InteractionItem[]) =&gt; {
    if (!elements.length) return;

    console.log(`element length: ${elements.length}`);
  };

  const chartRef = useRef&lt;ChartJS&gt;(null);

  const onClick = (event: MouseEvent&lt;HTMLCanvasElement&gt;) =&gt; {
    const { current: chart } = chartRef;

    if (!chart) {
      return;
    }

    printDatasetAtEvent(getDatasetAtEvent(chart, event));
    printElementAtEvent(getElementAtEvent(chart, event));
    printElementsAtEvent(getElementsAtEvent(chart, event));
  };

  return (
    &lt;Chart
      ref={chartRef}
      type="bar"
      onClick={onClick}
      options={options}
      data={data}
    /&gt;
  );
}
</code></pre>
<h1 id="write-a-chartjs-wrapper"><a class="header" href="#write-a-chartjs-wrapper">Write a chartjs wrapper</a></h1>
<p>In order to add title for each chart, we write a functional component to wrapper up every chart with a <code>h1</code>. Note we define the <code>h1</code> style using tailwindcss, setting div size(<code>h-96</code>) and text size(<code>text-3xl</code>), etc.</p>
<pre><code class="language-jsx">export const ChartWrapper: React.FC&lt;{
  title: string,
  children: React.ReactNode,
}&gt; = ({ title, children }) =&gt; {
  return (
    &lt;div className="max-h-96 h-96  bg-slate-50 border border-dashed"&gt;
      &lt;h1 className="text-3xl text-center font-bold underline"&gt;{title}&lt;/h1&gt;
      {children}
    &lt;/div&gt;
  );
};
</code></pre>
<p>The <code>ChartWrapper</code> is also a functional component that renders <code>title</code> in <code>h1</code> tag and <code>children</code> property below it.</p>
<p>All other chartjs components are straightforward.</p>
<h1 id="layout"><a class="header" href="#layout">Layout</a></h1>
<p>Now, we need to define the layout of all charts. We can use <code>grid</code> layout from tailwind and put all charts into it.</p>
<p>In <code>App</code> component, we iterate the components and render them in a div with <code>grid</code> class.</p>
<pre><code class="language-jsx">export default function App() {
  return (
    &lt;div&gt;
      &lt;Head&gt;
        &lt;title&gt;ChartJS + NextJS + TailwindCSS&lt;/title&gt;
        &lt;meta name="description" content="Generated by create next app" /&gt;
        &lt;meta name="viewport" content="width=device-width, initial-scale=1" /&gt;
        &lt;link rel="icon" href="/favicon.ico" /&gt;
      &lt;/Head&gt;
      &lt;main className={styles.main}&gt;
        &lt;div className={styles.description}&gt;
          &lt;h1 className="text-3xl text-center font-bold underline"&gt;
            ChartJS + NextJS + TailwindCSS
          &lt;/h1&gt;
          &lt;div className="container columns-2"&gt;
            &lt;div className="grid grid-cols-2 md:grid-cols-1 gap-0"&gt;
              {&lt;ComponentWrapper components={components} /&gt;}
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/main&gt;
    &lt;/div&gt;
  );
}
</code></pre>
<p>This is a React component called App that is exporting as a default. The component renders a main <code>div</code> element that contains a <code>Head</code> component and a main element with a className of <code>styles.main</code>. Within the main element, there is a div element with a <code>className</code> of <code>styles.description</code> that contains a <code>h1</code> element with a <code>className</code> of <code>"text-3xl text-center font-bold underline"</code> and some text.</p>
<p>The div element also contains a div element with a <code>className</code> of <code>"container columns-2"</code> that contains an inner div element with a className of <code>"grid grid-cols-2 md:grid-cols-1 gap-0"</code>. This inner div element renders the <code>ComponentWrapper</code> component passing an array of components in the components prop.</p>
<p>Here is the important part:</p>
<pre><code class="language-jsx">{
  &lt;ComponentWrapper components={components} /&gt;;
}
</code></pre>
<p>The <code>ComponentWrapper</code> component dynamically renders each component passed in the <code>components</code> array. The rendering of each component is wrapped in a <code>ChartWrapper</code> component that provides a title for each component.</p>
<h1 id="optimize"><a class="header" href="#optimize">Optimize</a></h1>
<p>Can we do better? The answer is yes!</p>
<p>Notice, for <code>ComponentWrapper</code> function component, it's more verbose. We could write it in another way.</p>
<p>Here is the old way.</p>
<pre><code class="language-jsx">// NOTE: OK but verbose
const ComponentWrapper: React.FC&lt;ChartProps&gt; = ({ components }) =&gt; {
  return (
    &lt;div&gt;
      {components.map((c, index) =&gt; {
        return (
          &lt;ChartWrapper key={index} title={c.title}&gt;
            &lt;c.component /&gt;
          &lt;/ChartWrapper&gt;
        );
      })}
    &lt;/div&gt;
  );
};
</code></pre>
<p>The new way:</p>
<pre><code class="language-jsx">// NOTE: concise
const ComponentWrapperNew: React.FC&lt;ChartProps&gt; = ({ components }) =&gt; {
  return (
    &lt;div&gt;
      {components.map((c, index) =&gt; {
        const { title, component: C } = c;

        return (
          &lt;ChartWrapper key={index} title={title}&gt;
            &lt;C /&gt;
          &lt;/ChartWrapper&gt;
        );
      })}
    &lt;/div&gt;
  );
};
</code></pre>
<p>To render list of charts components with titles and properties, we wrote two React component functions. Although both functions produce the same output, their implementation approaches are different.</p>
<p>The first function <code>ComponentWrapper</code> is a good method, but the downside is that it is quite verbose. It uses curly braces and a return statement to wrap the component inside <code>&lt;ChartWrapper&gt;</code>, and it also references <code>c.title</code> and <code>c.component</code> multiple times within the function body.</p>
<p>The second function <code>ComponentWrapperNew</code> is a more concise implementation. It uses ES6 destructuring syntax to get <code>title</code> and <code>component</code> from the <code>components</code> object, which avoids repeated use of <code>c.title</code> and <code>c.component</code>. Additionally, it uses a more descriptive variable name <code>C</code> for the component. We can also call it <code>ChartComponent</code> if you like.</p>
<p>Clearly, the second implementation is more succinct, easier to read and maintain, and also makes it easier to add new properties or methods. Therefore, we recommend using the second function <code>ComponentWrapperNew</code> as a more efficient programming practice.</p>
<p>To summarize, the primary difference between these two implementation methods is that the first one is verbose, which makes it difficult to read and maintain, while the second one is more concise and easier to read and maintain. The second function also uses destructuring, which is a useful syntax for improving readability by eliminating repetition. By using a more concise and readable implementation, you can streamline your code and make it more efficient.</p>
<h1 id="summary"><a class="header" href="#summary">Summary</a></h1>
<p>In this post, we compare and contrast two React component functions that are used to render a list of chart components with titles and properties. While both functions ultimately produce the same result, their implementation approaches are different.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup-tanstack-react-query-in-nextjs-project"><a class="header" href="#setup-tanstack-react-query-in-nextjs-project">Setup Tanstack React Query in NextJS Project</a></h1>
<!-- toc -->
<ul>
<li><a href="react-query/setup-tanstack-react-query-in-nextjs-project.html#introduction">Introduction</a></li>
<li><a href="react-query/setup-tanstack-react-query-in-nextjs-project.html#install">Install</a></li>
<li><a href="react-query/setup-tanstack-react-query-in-nextjs-project.html#use-tanstackreact-query-in-nextjs-project">Use tanstack/react-query in nextjs project</a></li>
<li><a href="react-query/setup-tanstack-react-query-in-nextjs-project.html#write-your-component">Write your component</a></li>
<li><a href="react-query/setup-tanstack-react-query-in-nextjs-project.html#jsontable---a-component-to-render-data-as-a-table">JSONTable - A component to render data as a table</a></li>
</ul>
<!-- tocstop -->
<h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>In the modern web development landscape, efficiently managing and handling data is a crucial aspect that can dramatically impact the user experience. React Query is a powerful data synchronization and state management library that aims to simplify fetching, caching, background updates and server state management in your React applications.</p>
<p>Next.js is a popular React framework that enables features such as Server-Side Rendering and Static Site Generation out of the box. This makes it a great choice for building performant, SEO-friendly web applications. However, when it comes to data fetching and managing server state, Next.js leaves the choice up to the developer.</p>
<p>Therefore, using React Query with Next.js can be a powerful combination for building robust, data-driven applications with improved user experience. This blog post will guide you step by step to integrating React Query in a Next.js project.</p>
<p>We will cover:</p>
<ul>
<li>Setting up a new Next.js project</li>
<li>Installing and setting up React Query</li>
<li>Fetching data using React Query</li>
<li>Displaying the fetched data using a table component</li>
</ul>
<p>No matter the size and scale of your application, using React Query with Next.js can improve the efficiency of your data operations and the overall quality of your product. Let's dive in!</p>
<h1 id="install"><a class="header" href="#install">Install</a></h1>
<p>To install tanstack/react-query, you can use yarn or npm:</p>
<pre><code class="language-bash">yarn add @tanstack/react-query
yarn add -D @tanstack/eslint-plugin-query
</code></pre>
<p>This will install tanstack/react-query (<code>"@tanstack/react-query": "^5.21.7"</code>) as a dependency in your project. See package.json for more details.</p>
<pre><code class="language-json">{
  "name": "mui-5-example",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@emotion/react": "^11.11.1",
    "@emotion/styled": "^11.11.0",
    "@mui/base": "^5.0.0-beta.16",
    "@mui/icons-material": "^5.11.11",
    "@mui/material": "^5.14.9",
    "@mui/styles": "^5.11.13",
    "@mui/system": "^5.14.9",
    "@mui/utils": "^5.14.9",
    "@mui/x-data-grid": "^6.14.0",
    "@mui/x-data-grid-generator": "^6.14.0",
    "@mui/x-data-grid-pro": "^6.14.0",
    "@tanstack/react-query": "^5.21.7",
    "@types/node": "18.15.11",
    "@types/react": "18.0.31",
    "@types/react-dom": "18.0.11",
    "@visx/group": "^3.3.0",
    "@visx/mock-data": "^3.3.0",
    "@visx/responsive": "^3.3.0",
    "@visx/scale": "^3.5.0",
    "@visx/shape": "^3.5.0",
    "@visx/text": "^3.3.0",
    "@visx/wordcloud": "^3.3.0",
    "eslint": "8.37.0",
    "eslint-config-next": "13.2.4",
    "expression-eval": "^5.0.1",
    "moment-timezone": "^0.5.44",
    "next": "13.2.4",
    "qs": "^6.11.2",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "react-query": "^3.39.3",
    "recharts": "^2.5.0",
    "typescript": "5.0.3"
  },
  "devDependencies": {
    "@tanstack/eslint-plugin-query": "^5.20.1"
  }
}
</code></pre>
<h1 id="use-tanstackreact-query-in-nextjs-project"><a class="header" href="#use-tanstackreact-query-in-nextjs-project">Use tanstack/react-query in nextjs project</a></h1>
<p>After installation, you can use it in nextjs project by adding the following code in <code>_app.tsx</code>:</p>
<pre><code class="language-typescript">import React from "react";
import "@/styles/globals.css";
import type { AppProps } from "next/app";

// import { QueryClient, QueryClientProvider } from "react-query";

import {
  Hydrate,
  QueryClient,
  QueryClientProvider,
} from "@tanstack/react-query";

// NOTE: Default code
// export default function App({ Component, pageProps }: AppProps) {
//   return &lt;Component {...pageProps} /&gt;
// }

// NOTE: Using react-query v3, for v4+, use tanstack/react-query
// export default function App({ Component, pageProps }: AppProps) {
//   // Create a QueryClient instance
//   const queryClient = new QueryClient();

//   return (
//     // Use QueryClientProvider to wrapper your application，and pass the queryClient to the component
//     &lt;QueryClientProvider client={queryClient}&gt;
//       &lt;Component {...pageProps} /&gt;
//     &lt;/QueryClientProvider&gt;
//   );
// }

export default function App({ Component, pageProps }: AppProps) {
  // Create a QueryClient instance
  const [queryClient] = React.useState(() =&gt; new QueryClient());

  return (
    &lt;QueryClientProvider client={queryClient}&gt;
      {/* &lt;Hydrate state={pageProps.dehydratedState}&gt; */}
      &lt;Component {...pageProps} /&gt;
      {/* &lt;/Hydrate&gt; */}
    &lt;/QueryClientProvider&gt;
  );
}
</code></pre>
<h1 id="write-your-component"><a class="header" href="#write-your-component">Write your component</a></h1>
<p>Now, we can write our component to use the <code>useQuery</code> hook.</p>
<p>The <code>useQuery</code> hook is a higher-order component that returns a <code>QueryClient</code> instance.</p>
<pre><code class="language-typescript">import React from "react";
// import { useQuery } from "react-query";
import { useQuery } from "@tanstack/react-query";

import type { InferGetServerSidePropsType, GetServerSideProps } from "next";
import JSONTable from "../../components/table/JSONTable";

type Repo = {
  name: string;
  stargazers_count: number;
};

// Function to fetch data
const fetchData = async () =&gt; {
  const response = await fetch("https://api.github.com/repos/vercel/next.js");
  if (!response.ok) {
    throw new Error("Network response was not ok");
  }
  return response.json();
};

function DataFetchUsingTanstackReactQuery() {
  // Using the useQuery hook to fetch data
  // const { data, error, isLoading } = useQuery("fetchData", fetchData);
  const { data, error, isLoading } = useQuery({
    queryKey: ["fetchData"],
    queryFn: fetchData,
  });

  if (isLoading) {
    return &lt;p&gt;Loading...&lt;/p&gt;;
  }

  if (error) {
    return &lt;p&gt;Error: {error.message}&lt;/p&gt;;
  }

  return (
    &lt;div&gt;
      &lt;h1&gt;Data from API:&lt;/h1&gt;
      &lt;JSONTable data={data} /&gt;
    &lt;/div&gt;
  );
}

export default DataFetchUsingTanstackReactQuery;
</code></pre>
<p>Starting with version 4 of @tanstack/react-query, there was a breaking change in how queries and mutations are called. Before version 4, it was possible to use the "array" syntax or the "object" syntax when calling query functions. After version 4, only the "object" form is allowed.</p>
<pre><code class="language-typescript">// Older version:
// const { data, error, isLoading } = useQuery("fetchData", fetchData);
// New version:
const { data, error, isLoading } = useQuery({
  queryKey: ["fetchData"],
  queryFn: fetchData,
});
</code></pre>
<p>Below is the difference between older and newer versions of @tanstack/react-query.</p>
<pre><code class="language-diff">- useQuery(key, fn, options)
+ useQuery({ queryKey, queryFn, ...options })

- useInfiniteQuery(key, fn, options)
+ useInfiniteQuery({ queryKey, queryFn, ...options })

- useMutation(fn, options)
+ useMutation({ mutationFn, ...options })

- useIsFetching(key, filters)
+ useIsFetching({ queryKey, ...filters })

- useIsMutating(key, filters)
+ useIsMutating({ mutationKey, ...filters })
</code></pre>
<h1 id="jsontable---a-component-to-render-data-as-a-table"><a class="header" href="#jsontable---a-component-to-render-data-as-a-table">JSONTable - A component to render data as a table</a></h1>
<p>As we use MUI to render the table, we write a <code>JSONTable</code> component , which takes a <code>data</code> prop and renders the data as a table.</p>
<p>The code is pretty simple, but we need to import the <code>Table</code> and <code>TableHead</code> components from <code>@mui/material</code>.</p>
<pre><code class="language-typescript">import React from "react";
import {
  Table,
  TableHead,
  TableBody,
  TableRow,
  TableCell,
  TableContainer,
  Paper,
} from "@mui/material";

const JSONTable = ({ data }) =&gt; {
  const renderTableRows = () =&gt; {
    return Object.entries(data).map(([key, value]) =&gt; (
      &lt;TableRow key={key}&gt;
        &lt;TableCell sx={{ wordBreak: "break-word", maxWidth: 20 }}&gt;
          {key}
        &lt;/TableCell&gt;
        &lt;TableCell sx={{ wordBreak: "break-word", maxWidth: 800 }}&gt;
          {/* // NOTE: when value is boolean, we should call toString to change it
          to string instead of JSON.stringify */}
          {typeof value === "object"
            ? JSON.stringify(value)
            : typeof value === "boolean"
            ? value.toString()
            : value}
          {/* {typeof value === "object" ? JSON.stringify(value) : value} */}
          {/* {JSON.stringify(value)} */}
          {/* {typeof value} */}
        &lt;/TableCell&gt;
      &lt;/TableRow&gt;
    ));
  };

  return (
    &lt;TableContainer
      component={Paper}
      style={{ margin: "20px", marginRight: "40px" }}
    &gt;
      &lt;Table sx={{ minWidth: 650 }} aria-label="simple table"&gt;
        &lt;TableHead&gt;
          &lt;TableRow&gt;
            &lt;TableCell&gt;Property&lt;/TableCell&gt;
            &lt;TableCell&gt;Value&lt;/TableCell&gt;
          &lt;/TableRow&gt;
        &lt;/TableHead&gt;
        &lt;TableBody&gt;{renderTableRows()}&lt;/TableBody&gt;
      &lt;/Table&gt;
    &lt;/TableContainer&gt;
  );
};

export default JSONTable;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="register-gitlab-runner-on-amazon-linux-2"><a class="header" href="#register-gitlab-runner-on-amazon-linux-2">Register gitlab runner on Amazon Linux 2</a></h1>
<h1 id="table-of-contents-1"><a class="header" href="#table-of-contents-1">Table of Contents</a></h1>
<!--ts-->
<ul>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#register-gitlab-runner-on-amazon-linux-2">Register gitlab runner on Amazon Linux 2</a></li>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#start-aws-ec2-instance">Start AWS EC2 Instance</a></li>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#install-gitlab-runner-on-amazon-linux-2">Install gitlab runner on Amazon Linux 2</a></li>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#register-gitlab-runner">Register gitlab runner</a></li>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#set-gitlab_port-to-443">Set GITLAB_PORT to 443</a></li>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#write-gitlab-ciyml-for-go-project">Write .gitlab-ci.yml for go project</a></li>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#test-the-runner">Test the runner</a></li>
</ul>
<!--te-->
<h1 id="start-aws-ec2-instance"><a class="header" href="#start-aws-ec2-instance">Start AWS EC2 Instance</a></h1>
<p>You can create aws ec2 instance either in aws console or using aws cli.</p>
<p>Notice you should enable public ip address if your ec2 instance is in public subnet of you VPC, otherwise you will not be able to access the internet!</p>
<h1 id="install-gitlab-runner-on-amazon-linux-2"><a class="header" href="#install-gitlab-runner-on-amazon-linux-2">Install gitlab runner on Amazon Linux 2</a></h1>
<p>Next, we'll install gitlab runner on Amazon Linux 2. Run the following bash script:</p>
<pre><code class="language-bash"># install on amazon linux 2
# refs: https://github.com/beda-software/FAQ/blob/master/aws-ec2-gitlab-runner.md
curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh" | sudo bash
sudo -E yum install gitlab-runner
sudo amazon-linux-extras install docker
sudo service docker start
sudo usermod -a -G docker ec2-user
sudo systemctl enable docker.service
sudo systemctl enable containerd.service
sudo usermod -a -G docker ec2-user
sudo yum install -y git
</code></pre>
<h1 id="register-gitlab-runner"><a class="header" href="#register-gitlab-runner">Register gitlab runner</a></h1>
<p>You can register gitlab runner by using <code>gitlab-ci-multi-runner</code> command:</p>
<pre><code class="language-bash"># register runner
# sudo gitlab-ci-multi-runner register -n --url GITLAB_URL --registration-token "TOKEN"   --executor docker   --description "Name of docker runner"   --docker-image "docker:latest" --docker-privileged
</code></pre>
<p>Replace <code>GITLAB_URL</code> and <code>TOKEN</code> with your self-hosted gitlab url or token. You can go to <code>https://gitlab.mycompany.com/admin/runners</code> and click <code>Register an instance runner</code> button, and you will see the <code>TOKEN</code> in the popup.</p>
<pre><code class="language-bash"># register runner in gitlab
sudo gitlab-ci-multi-runner register -n --url https://gitlab.mycompany.com/ --registration-token "A____TOKEN_____A"   --executor docker   --description "Name of docker runner"   --docker-image "docker:latest" --docker-privileged
</code></pre>
<p>Output:</p>
<pre><code>Runtime platform                                    arch=amd64 os=linux pid=8095 revision=865283c5 version=16.1.0
Running in system-mode.

WARNING: Support for registration tokens and runner parameters in the 'register' command has been deprecated in GitLab Runner 15.6 and will be replaced with support for authentication tokens. For more information, see https://gitlab.com/gitlab-org/gitlab/-/issues/380872
Registering runner... succeeded                     runner=paaaaaaa
Runner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded!

Configuration (with the authentication token) was saved in "/etc/gitlab-runner/config.toml"
</code></pre>
<p>You will see a runner with name <code>paaaaaaa</code> is registered successfully.</p>
<p>And you can also config the runner in <code>/etc/gitlab-runner/config.toml</code>.</p>
<p>You can go to runners page in gitlab Admin and check if the runner is registered successfully.</p>
<p><img src="https://github.com/lichuan6/lichuan6.github.io/assets/74223747/c4df4b54-ae28-40e2-be29-66a29b2206f1" alt="Runner" /></p>
<h1 id="set-gitlab_port-to-443"><a class="header" href="#set-gitlab_port-to-443">Set GITLAB_PORT to 443</a></h1>
<p>As the runner is registered successfully, you may encounter an error like this:</p>
<pre><code>gitlab-runner version 14.10.1 fails to clone a repo configured with a https repo URL, stating HTTP Basic: Access denied.
</code></pre>
<p>As we deploy gitlab using <code>https://github.com/sameersbn/docker-gitlab</code>, you may need to set <code>GITLAB_PORT</code> to <code>443</code> based on your configuration for load balancer above gitlab service, or add <code>clone_url</code> to the runner config file <code>/etc/gitlab-runner/config.toml</code>. Also, don't forget to restart docker servcie <code>sudo sercie docker restart</code>.</p>
<pre><code class="language-toml">concurrent = 1
check_interval = 0
shutdown_timeout = 0

[session_server]
  session_timeout = 1800

[[runners]]
  name = "Name of docker runner"
  url = "https://gitlab.mycompany.com/"
  clone_url = "https://gitlab.mycompany.com/"
  id = 1
  token = "s_____________n"
  token_obtained_at = 2023-07-22T01:20:41Z
  token_expires_at = 0001-01-01T00:00:00Z
  executor = "docker"
  [runners.cache]
    MaxUploadedArchiveSize = 0
  [runners.docker]
    tls_verify = false
    image = "docker:latest"
    privileged = true
    disable_entrypoint_overwrite = false
    oom_kill_disable = false
    disable_cache = false
    volumes = ["/cache"]
    shm_size = 0
</code></pre>
<h1 id="write-gitlab-ciyml-for-go-project"><a class="header" href="#write-gitlab-ciyml-for-go-project">Write .gitlab-ci.yml for go project</a></h1>
<p>For go project, you can write a gitlab ci file and test the runner.</p>
<p>Here is a simple gitlab ci file:</p>
<pre><code class="language-yaml"># You can copy and paste this template into a new `.gitlab-ci.yml` file.
# You should not add this template to an existing `.gitlab-ci.yml` file by using the `include:` keyword.
#
# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html
# This specific template is located at:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Go.gitlab-ci.yml

image: golang:latest

stages:
  - test
  - build
  - deploy

format:
  stage: test
  script:
    - go fmt $(go list ./... | grep -v /vendor/)
    - go vet $(go list ./... | grep -v /vendor/)
    - go test -race $(go list ./... | grep -v /vendor/)

compile:
  stage: build
  script:
    - mkdir -p mybinaries
    - go build -o mybinaries ./...
  artifacts:
    paths:
      - mybinaries

deploy:
  stage: deploy
  script: echo "Define your deployment script!"
  environment: production
</code></pre>
<h1 id="test-the-runner"><a class="header" href="#test-the-runner">Test the runner</a></h1>
<p>You can trigger ci either by committing on <code>main</code> branch or clicking <code>Run Pipeline</code> in your project's pipeline page, i.e https://gitlab.mycompany.com/myname/go-ci-test/-/pipelines</p>
<p>If the pipeline is passed, your gitlab runner is runner successfully.</p>
<p><img src="https://github.com/lichuan6/lichuan6.github.io/assets/74223747/aaf5c27f-7451-4061-a0f6-181250f4abb0" alt="Pipeline" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-organise-application-error-in-actix-web-application"><a class="header" href="#how-to-organise-application-error-in-actix-web-application">How to organise application Error in actix-web application</a></h1>
<h1 id="table-of-contents-2"><a class="header" href="#table-of-contents-2">Table of Contents</a></h1>
<!--ts-->
<ul>
<li><a href="rust/error/how-to-organise-application-error-in-actix-web-application.html#how-to-organise-application-error-in-actix-web-application">How to organise application Error in actix-web application</a></li>
<li><a href="rust/error/how-to-organise-application-error-in-actix-web-application.html#dao-layer">Dao layer</a></li>
<li><a href="rust/error/how-to-organise-application-error-in-actix-web-application.html#actix-web-http-layer">Actix-web http layer</a></li>
<li><a href="rust/error/how-to-organise-application-error-in-actix-web-application.html#solution">Solution</a></li>
</ul>
<!--te-->
<h1 id="dao-layer"><a class="header" href="#dao-layer">Dao layer</a></h1>
<p>For dao layer, usually we use <code>lib::Result</code> as return type. Below is an example of fetching all users when using <code>clickhosue-rs</code> crate:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use clickhouse::error::{Error, Result};

pub async fn get_all_users(client: &amp;Client) -&gt; Result&lt;Vec&lt;User&gt;&gt; {
    let users = client
        .query("SELECT ?fields FROM users")
        .fetch_all::&lt;User&gt;()
        .await?;

    Ok(users)
}
<span class="boring">}</span></code></pre></pre>
<p>Notice, the <code>Result</code> is not <code>std::result::Result</code> type, it is a type that use <code>clickhouse::error::Error</code> as the error type in <code>Result</code> generic type.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::{error::Error as StdError, fmt, io, result, str::Utf8Error};

use serde::{de, ser};

/// A result with a specified [`Error`] type.
pub type Result&lt;T, E = Error&gt; = result::Result&lt;T, E&gt;;


/// Represents all possible errors.
#[derive(Debug, thiserror::Error)]
#[non_exhaustive]
#[allow(missing_docs)]
pub enum Error {
    #[error("invalid params: {0}")]
    InvalidParams(#[source] Box&lt;dyn StdError + Send + Sync&gt;),
    #[error("network error: {0}")]
    Network(#[source] Box&lt;dyn StdError + Send + Sync&gt;),
    #[error("compression error: {0}")]
    Compression(#[source] Box&lt;dyn StdError + Send + Sync&gt;),
    #[error("decompression error: {0}")]
    Decompression(#[source] Box&lt;dyn StdError + Send + Sync&gt;),
    #[error("no rows returned by a query that expected to return at least one row")]
    RowNotFound,
    #[error("sequences must have a known size ahead of time")]
    SequenceMustHaveLength,
    #[error("`deserialize_any` is not supported")]
    DeserializeAnyNotSupported,
    #[error("not enough data, probably a row type mismatches a database schema")]
    NotEnoughData,
    #[error("string is not valid utf8")]
    InvalidUtf8Encoding(#[from] Utf8Error),
    #[error("tag for enum is not valid")]
    InvalidTagEncoding(usize),
    #[error("a custom error message from serde: {0}")]
    Custom(String),
    #[error("bad response: {0}")]
    BadResponse(String),
    #[error("timeout expired")]
    TimedOut,

    // Internally handled errors, not part of public API.
    // XXX: move to another error?
    #[error("internal error: too small buffer, need another {0} bytes")]
    #[doc(hidden)]
    TooSmallBuffer(usize),
}
<span class="boring">}</span></code></pre></pre>
<h1 id="actix-web-http-layer"><a class="header" href="#actix-web-http-layer">Actix-web http layer</a></h1>
<p>Actix-web framework requires the error type is <code>actix_web::error::Error</code> if <code>actix_web::Result</code> is used as the return type.</p>
<p><code>Result</code> type in actix-web :</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub use self::error::Error;
pub use self::internal::*;
pub use self::response_error::ResponseError;
pub(crate) use macros::{downcast_dyn, downcast_get_type_id};

/// A convenience [`Result`](std::result::Result) for Actix Web operations.
///
/// This type alias is generally used to avoid writing out `actix_http::Error` directly.
pub type Result&lt;T, E = Error&gt; = std::result::Result&lt;T, E&gt;;
<span class="boring">}</span></code></pre></pre>
<p><code>Error</code> type in actix-web :</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// General purpose Actix Web error.
///
/// An Actix Web error is used to carry errors from `std::error` through actix in a convenient way.
/// It can be created through converting errors with `into()`.
///
/// Whenever it is created from an external object a response error is created for it that can be
/// used to create an HTTP response from it this means that if you have access to an actix `Error`
/// you can always get a `ResponseError` reference from it.
pub struct Error {
    cause: Box&lt;dyn ResponseError&gt;,
}
<span class="boring">}</span></code></pre></pre>
<p>Normally, we write actix-web handler and call dao functions like this:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub async fn get_all_users(data: web::Data&lt;AppState&gt;) -&gt; actix_web::Result&lt;impl Responder&gt; {
    let db = &amp;data.db;

    // call dao function to fetch data
    let users = users::get_all_users(db).await?;
    Ok(web::Json(users))
}
<span class="boring">}</span></code></pre></pre>
<p>If you write a http handler like this and call function in dao(i.e. <code>dao::get_all_users</code>) function, which returns an error from the dao crate, error will happen.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>   --&gt; src/user/http.rs:348:54
    |
348 |     let users = users::get_all(db).await?;
    |                                         ^ the trait `ResponseError` is not implemented for `clickhouse::error::Error`
    |
    = help: the following other types implement trait `ResponseError`:
              AppError
              BlockingError
              Box&lt;(dyn StdError + 'static)&gt;
              HttpError
              Infallible
              InvalidHeaderValue
              JsonPayloadError
              PathError
            and 17 others
    = note: required for `actix_web::Error` to implement `std::convert::From&lt;clickhouse::error::Error&gt;`
    = note: required for `Result&lt;_, actix_web::Error&gt;` to implement `FromResidual&lt;Result&lt;Infallible, clickhouse::error::Error&gt;&gt;`
<span class="boring">}</span></code></pre></pre>
<p>It means that you cannot convert <code>clickhouse::error::Error</code> to <code>actix_web::Error</code>.</p>
<p>The reason is that the error type in dao function is <code>clickhouse::error::Error</code> and <code>actix_web::Error</code> in http handler. You have to implement <code>From</code> trait as rust compiler told you.</p>
<h1 id="solution"><a class="header" href="#solution">Solution</a></h1>
<p>One possible solution is to define application error and implement <code>From</code> trait, which will convert <code>clickhouse::error::Error</code> to <code>AppError</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Debug)]
pub enum AppError {
    ClickhouseError(ClickhouseError),
    // ... other error variants
}

impl ResponseError for AppError {
    fn error_response(&amp;self) -&gt; HttpResponse {
        HttpResponse::InternalServerError().body(self.to_string())
        // We can also use match to handle specific error define in clickhouse::error::Error
        // match *self {
        //     AppError::ClickhouseError(ref err) =&gt; match err {
        //         ClickhouseError::Timeout(err) =&gt; HttpResponse::InternalServerError()
        //             .body(format!("Clickhouse server error: {}", err)),
        //         ClickhouseError::Network(err) =&gt; {
        //             HttpResponse::BadRequest().body(format!("Clickhouse client error: {}", err))
        //         }
        //         _ =&gt; HttpResponse::InternalServerError().body("Unknown error"),
        //     }, // ... handle other error variants
        // }
    }
}

use std::fmt;

impl fmt::Display for AppError {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter) -&gt; fmt::Result {
        match *self {
            AppError::ClickhouseError(ref err) =&gt; {
                write!(f, "Clickhouse error: {}", err)
            } // ... handle other error variants
        }
    }
}

impl From&lt;ClickhouseError&gt; for AppError {
    fn from(error: ClickhouseError) -&gt; Self {
        AppError::ClickhouseError(error)
    }
}
<span class="boring">}</span></code></pre></pre>
<p>Finally, you need to modify actix-web handler:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use clickhouse::error::{Error, Result};

// Previous function signature
// pub async fn get_all_users(data: web::Data&lt;AppState&gt;) -&gt; actix_web::Result&lt;impl Responder&gt; {
// Pass AppError to handler's return type
pub async fn get_all_users(data: web::Data&lt;AppState&gt;) -&gt; actix_web::Result&lt;impl Responder, AppError&gt; {
    let db = &amp;data.db;

    // call dao function to fetch data
    let users = users::get_all_users(db).await?;
    Ok(web::Json(users))
}
<span class="boring">}</span></code></pre></pre>
<p>🎉🎉🎉</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="serialize-timeoffsetdatatime-type-using-serde_as-in-serde_with-crate"><a class="header" href="#serialize-timeoffsetdatatime-type-using-serde_as-in-serde_with-crate">Serialize time::OffsetDataTime type using serde_as in serde_with crate</a></h1>
<h1 id="table-of-contents-3"><a class="header" href="#table-of-contents-3">Table of Contents</a></h1>
<!--ts-->
<ul>
<li><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html#serialize-timeoffsetdatatime-type-using-serde_as-in-serde_with-crate">Serialize time::OffsetDataTime type using serde_as in serde_with crate</a></li>
<li><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html#table-design">Table design</a></li>
<li><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html#database-management-using-sqlx">Database management using sqlx</a></li>
<li><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html#writing-data-access-layer">Writing Data Access Layer</a></li>
<li><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html#write-actix-handler">Write actix handler</a>
<ul>
<li><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html#appstate">AppState</a></li>
<li><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html#actix-handler">Actix handler</a></li>
<li><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html#httpserver-setup">HttpServer setup</a></li>
<li><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html#config-routes">Config routes</a></li>
<li><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html#run-application">Run application</a></li>
</ul>
</li>
<li><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html#request-data-through-api">Request data through api</a></li>
<li><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html#choose-correct-serialize-method">Choose correct serialize method</a></li>
<li><a href="rust/actix-web/serialize-time-offsetdatetime-type-using-serde-as-in-serde-with-crate.html#request-data-through-api-after-using-serde_as">Request data through api after using serde_as</a></li>
</ul>
<!--te-->
<h1 id="table-design"><a class="header" href="#table-design">Table design</a></h1>
<p>When we develop backend api using postgres and sqlx, you will definitely use date in your database design. Take user table as an example:</p>
<pre><code class="language-sql">-- Add migration script here
CREATE TYPE gender AS ENUM ('male', 'female', 'other');

-- Table `users`
CREATE TABLE
  IF NOT EXISTS users (
    id BIGSERIAL PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    gender GENDER NOT NULL,
    disabled BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW ()
  );
</code></pre>
<p>In the provided example, the <code>users</code> table includes a <code>created_at</code> column of type <code>TIMESTAMPTZ</code>.</p>
<p>In PostgreSQL, the <code>TIMESTAMPTZ</code> data type stands for "timestamp with time zone."</p>
<h1 id="database-management-using-sqlx"><a class="header" href="#database-management-using-sqlx">Database management using sqlx</a></h1>
<p>We can also use <code>sqlx</code> to generate migration and add the sql above to the migration script.</p>
<p>The following example will use <code>sqlx</code>, which is <a href="https://github.com/launchbadge/sqlx">SQLx</a>'s associated command-line utility for managing databases, migrations, to create database and generate the migration.</p>
<pre><code class="language-bash"># create database
DATABASE_URL=postgres://localhost/test sqlx database create

# create migration
DATABASE_URL=postgres://localhost/test sqlx migrate add user
</code></pre>
<p>We can list all migration scripts in <code>migrations</code> direction, which is generated by <code>sqlx migrate add user</code> command.</p>
<pre><code>drwxr-xr-x   - username 22 Aug 14:22 migrations
.rw-r--r-- 334 username 22 Aug 14:22 └── 20230822062052_user.sql
</code></pre>
<p>We added above sql to file <code>20230822062052_user.sql</code> and <code>sqlx</code> will handle the migration.</p>
<h1 id="writing-data-access-layer"><a class="header" href="#writing-data-access-layer">Writing Data Access Layer</a></h1>
<p>We can write an <code>all_users</code> function to fetch data from database using <code>sqlx</code> crate.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use serde::Serialize;
use sqlx::PgPool;
use time::OffsetDateTime;

#[derive(Debug, Serialize)]
pub struct User {
    pub id: i64,
    pub username: String,
    pub disabled: bool,
    pub gender: Gender,
    pub created_at: OffsetDateTime,
}

#[derive(Clone, PartialEq, PartialOrd, Serialize, sqlx::Type, Debug)]
#[sqlx(type_name = "gender")]
#[sqlx(rename_all = "lowercase")]
pub enum Gender {
    Male,
    Female,
    Other,
}

impl User {
    pub async fn all(connection: &amp;PgPool) -&gt; Result&lt;Vec&lt;User&gt;, sqlx::Error&gt; {
        let users = sqlx::query_as!(
            User,
            r#"
            SELECT
                id,
                username,
                gender as "gender: _",
                disabled,
                created_at
            FROM users
            "#
        )
        .fetch_all(connection)
        .await?;

        Ok(users)
    }
}
<span class="boring">}</span></code></pre></pre>
<p>The code snippet above uses the <code>sqlx</code> crate to interact with a PostgreSQL database and retrieve user data.</p>
<ul>
<li>The <code>User</code> struct represents a user entity and is serialized using the serde crate. It contains fields such as <code>id</code>, <code>username</code>, <code>disabled</code>, <code>gender</code>, and <code>created_at</code>, representing the corresponding columns in the database table.</li>
<li>The <code>Gender</code> enum represents the possible genders a user can have. It is derived from Clone, PartialEq, PartialOrd, and Serialize. The <code>sqlx::Type</code> trait is implemented to specify that this <code>enum</code> should be treated as a PostgreSQL custom type named "gender". The <code>sqlx(rename_all)</code> attribute is used to specify that the enum variants should be serialized in lowercase. You can refer to <a href="https://docs.rs/sqlx/latest/sqlx/trait.FromRow.html#rename_all">rename_all</a> for more details.
If you don't specify <code>sqlx(rename_all)</code>, an error will occur:</li>
</ul>
<pre><code>thread 'actix-rt|system:0|arbiter:0' panicked at 'called `Result::unwrap()` on an `Err` value: ColumnDecode { index: "2", source: "invalid value \"male\" for enum Gender" }', enum-example/src/bin/enum.rs:33:45
</code></pre>
<ul>
<li>The <code>User</code> struct also contains an <code>all</code> function that retrieves all users from the database. It takes a reference to a <code>PgPool</code> connection pool as a parameter and returns a <code>Result</code> with a vector of <code>User</code> instances or an <code>sqlx::Error</code> if an error occurs.</li>
<li>Inside the <code>all</code> function, a SQL query is defined using the <code>sqlx::query_as!</code> macro. It selects the necessary columns from the <code>users</code> table, including mapping the <code>gender</code> column to the <code>Gender</code> enum using the as <code>"gender: _"</code> syntax.</li>
<li>Finally, the <code>fetch_all</code> method is called on the query to execute it and retrieve all rows as a vector of User instances. The result is then returned as a Result.</li>
</ul>
<h1 id="write-actix-handler"><a class="header" href="#write-actix-handler">Write actix handler</a></h1>
<h2 id="appstate"><a class="header" href="#appstate">AppState</a></h2>
<p>Once we have the code implemented, let's see how we can use it to retrieve user data from a PostgreSQL database.</p>
<p>First, we define <code>AppState</code> struct to represent the server's state, which contains two fields: <code>app_name</code>, a string representing the application name, and <code>pool</code>, a <code>PgPool</code> instance representing the connection pool to the PostgreSQL database.</p>
<p>You can also add more to <code>AppState</code>, i.e. redis client to exchange data from Redis or kafka client to send or receive messages from Kafka, etc.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// This struct represents state
struct AppState {
    app_name: String,
    pool: PgPool,
}
<span class="boring">}</span></code></pre></pre>
<h2 id="actix-handler"><a class="header" href="#actix-handler">Actix handler</a></h2>
<p>Then, we define a handler for retrieving all users.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn all_users(data: web::Data&lt;AppState&gt;) -&gt; Result&lt;impl Responder&gt; {
    let connection = &amp;data.pool;
    let users = User::all(connection).await.unwrap();
    Ok(web::Json(users))
}
<span class="boring">}</span></code></pre></pre>
<p>The <code>all_users</code> function is an asynchronous handler that retrieves all users from the database. It takes a <code>web::Data</code> parameter containing the shared <code>AppState</code> data. Inside the function, it accesses the <code>PgPool</code> instance from the shared data and uses the <code>User</code> model to fetch all users from the database asynchronously.</p>
<h2 id="httpserver-setup"><a class="header" href="#httpserver-setup">HttpServer setup</a></h2>
<p>Next, we will create a <code>PgPool</code> instance and store the pool in application state variable, pass in a <code>Data::new(AppState { ... })</code> instance using <code>app_data</code> method.</p>
<pre><pre class="playground"><code class="language-rust">use sqlx::postgres::{PgPool, PgPoolOptions};

async fn main() -&gt; std::io::Result&lt;()&gt; {
    env::set_var("RUST_LOG", "info");
    env_logger::init();

    let db_url = "postgres://localhost/test";
    let pool = connect(db_url).await.unwrap();
    HttpServer::new(move || {
        App::new()
            // .app_data(pool.clone())
            .app_data(Data::new(AppState {
                app_name: "enum".into(),
                pool: pool.clone(),
            }))
            .service(web::scope("/api/v1").configure(config))
            .route("/health", web::get().to(health))
    })
    .bind(("0.0.0.0", 8080))?
    .run()
    .await
}

/// Open a connection to a database
pub async fn connect(db_url: &amp;str) -&gt; sqlx::Result&lt;PgPool&gt; {
    // NOTE: older version of sqlx use PgPool, for newer version use
    // PgPoolOptions::new to create a pool
    //
    // let pool = PgPool::new(db_url).await?;

    // Create a connection pool
    let pool = PgPoolOptions::new()
        .max_connections(5)
        // .connect("postgres://localhost/test")
        // .connect(&amp;env::var("DATABASE_URL")?)
        .connect(db_url)
        .await?;
    Ok(pool)
}</code></pre></pre>
<h2 id="config-routes"><a class="header" href="#config-routes">Config routes</a></h2>
<p>Finally, we will configure routes for the application.</p>
<p>We can use <code>configure</code> method to configure routes by passing an <code>function</code> with <code>F: FnOnce(&amp;mut ServiceConfig)</code> trait bound like this:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>HttpServer::new(move || {
    App::new()
        // .app_data(pool.clone())
        .app_data(Data::new(AppState {
            app_name: "enum".into(),
            pool: pool.clone(),
        }))
        // config routers
        .service(web::scope("/api/v1").configure(config))
        .route("/health", web::get().to(health))
})
.bind(("0.0.0.0", 8080))?
.run()
.await
<span class="boring">}</span></code></pre></pre>
<p>Here is the signature for <code>configure</code> method:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    pub fn configure&lt;F&gt;(mut self, cfg_fn: F) -&gt; Self
    where
        F: FnOnce(&amp;mut ServiceConfig);
<span class="boring">}</span></code></pre></pre>
<p>And our config method:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use actix_web::{
    web::{self, Data, ServiceConfig},
    web::{get, post, resource as r, scope},
    App, Error, HttpRequest, HttpResponse, HttpServer, Responder, Result,
};

// this function could be located in different module
pub fn config(cfg: &amp;mut ServiceConfig) {
    cfg
        // users
        .service(scope("/users").service(
            r("").route(get().to(all_users)), // .route(post().to(delete_user)),
        ));
}
<span class="boring">}</span></code></pre></pre>
<h2 id="run-the-application"><a class="header" href="#run-the-application">Run the application</a></h2>
<p>The application is configured with routes using the <code>service</code> and <code>route</code> methods. It includes a scope for API versioning with <code>/api/v1</code> and sets up a route for a health check endpoint ("/health") and a route to retrieve all users ("/users").</p>
<p>With all things tied up, we can run application using <code>cargo run</code> or <code>cargo run --bin &lt;binary&gt;</code> if you have multiple binaries in you project:</p>
<pre><code>    Finished dev [unoptimized + debuginfo] target(s) in 2.73s
     Running `target/debug/enum`
[2023-08-23T02:00:37Z INFO  actix_server::builder] starting 10 workers
[2023-08-23T02:00:37Z INFO  actix_server::server] Actix runtime found; starting in Actix runtime
</code></pre>
<h1 id="request-data-through-api"><a class="header" href="#request-data-through-api">Request data through api</a></h1>
<p>Now it's time to test the api.</p>
<p>We can request the user data through <code>/api/v1/users</code> endpoint:</p>
<pre><code class="language-bash">curl '0:8080/api/v1/users' | jq
</code></pre>
<p>Output:</p>
<pre><code class="language-json">[
  {
    "id": 1,
    "username": "john_doe",
    "disabled": false,
    "gender": "Male",
    "created_at": [2023, 234, 15, 3, 34, 422482000, 0, 0, 0]
  },
  {
    "id": 2,
    "username": "jane_smith",
    "disabled": true,
    "gender": "Female",
    "created_at": [2023, 234, 15, 3, 34, 422482000, 0, 0, 0]
  },
  {
    "id": 3,
    "username": "alex_jones",
    "disabled": false,
    "gender": "Other",
    "created_at": [2023, 234, 15, 3, 34, 422482000, 0, 0, 0]
  }
]
</code></pre>
<p>We have some trouble. The <code>created_at</code> is returned as an array, which should be a string like this: <code>2023-08-22T15:03:34.422482Z</code>. How to solve this problem?</p>
<h1 id="choose-correct-serialize-method"><a class="header" href="#choose-correct-serialize-method">Choose correct serialize method</a></h1>
<p>To fix the serialization problem of <code>OffsetDataTime</code> data type in <code>User</code> struct, we need to specify corrent serialization method for <code>created_at</code> field.</p>
<p>We can use <code>serce_with</code> crate and use <code>Rfc3339</code> in <code>serde_as</code> macro, which will serialize <code>OffsetDataTime</code> like this <code>1985-04-12T23:20:50.52Z</code> instead of an array of integers <code>[2023, 234, 15, 3, 34, 422482000, 0, 0, 0]</code>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Well-known formats, typically standards.
pub mod well_known {
    pub mod iso8601;
    mod rfc2822;
    mod rfc3339;

    #[doc(inline)]
    pub use iso8601::Iso8601;
    pub use rfc2822::Rfc2822;
    pub use rfc3339::Rfc3339;
}
<span class="boring">}</span></code></pre></pre>
<p>You can use <code>serde_with</code> crate as follows:</p>
<ul>
<li>Place the <code>#[serde_as]</code> attribute before the <code>#[derive]</code> attribute.</li>
<li>Use <code>#[serde_as(as = "...")</code>] instead of <code>#[serde(with = "...")]</code> to annotate field in struct</li>
</ul>
<p>Below is an example of using <code>serde_with</code> together with <code>serde_as</code> for <code>User</code> struct.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use time::format_description::well_known::Rfc3339;

#[serde_with::serde_as]
#[derive(Debug, Serialize)]
pub struct User {
    pub id: i64,
    pub username: String,
    pub disabled: bool,
    pub gender: Gender,
    #[serde_as(as = "Rfc3339")]
    pub created_at: OffsetDateTime,
}

#[derive(Clone, PartialEq, PartialOrd, Serialize, sqlx::Type, Debug)]
#[sqlx(type_name = "gender")]
#[sqlx(rename_all = "lowercase")]
pub enum Gender {
    Male,
    Female,
    Other,
}
<span class="boring">}</span></code></pre></pre>
<p>Notice, we use <code>#[serde_as(as = "Rfc3339")]</code> to annotate <code>created_at</code> field with <code>OffsetDataTime</code> type.</p>
<p>It's quite convenient to use.</p>
<h1 id="request-data-through-api-after-using-serde_as"><a class="header" href="#request-data-through-api-after-using-serde_as">Request data through api after using serde_as</a></h1>
<p>Now, when we request the data, we get the datetime as we wanted.</p>
<pre><code class="language-bash">curl '0:8080/api/v1/users' | jq
</code></pre>
<p>Output:</p>
<pre><code class="language-json">[
  {
    "id": 1,
    "username": "john_doe",
    "disabled": false,
    "gender": "Male",
    "created_at": "2023-08-22T15:03:34.422482Z"
  },
  {
    "id": 2,
    "username": "jane_smith",
    "disabled": true,
    "gender": "Female",
    "created_at": "2023-08-22T15:03:34.422482Z"
  },
  {
    "id": 3,
    "username": "alex_jones",
    "disabled": false,
    "gender": "Other",
    "created_at": "2023-08-22T15:03:34.422482Z"
  }
]
</code></pre>
<p>🎉🎉🎉</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="upgrade-diesel-to-20"><a class="header" href="#upgrade-diesel-to-20">Upgrade diesel to 2.0</a></h1>
<h1 id="table-of-contents-4"><a class="header" href="#table-of-contents-4">Table of Contents</a></h1>
<!-- toc -->
<ul>
<li><a href="rust/diesel/upgrade-diesel-to-2.0.html#an-introduction-to-diesel-20">An introduction to diesel 2.0</a></li>
<li><a href="rust/diesel/upgrade-diesel-to-2.0.html#upgrade-to-diesel-20">Upgrade to diesel 2.0</a>
<ul>
<li><a href="rust/diesel/upgrade-diesel-to-2.0.html#upgrade-diesel-version-in-cargotoml">Upgrade diesel version in Cargo.toml</a></li>
<li><a href="rust/diesel/upgrade-diesel-to-2.0.html#add-mut-to-pgconnection-and-dao-functions">Add mut to PgConnection and dao functions</a></li>
<li><a href="rust/diesel/upgrade-diesel-to-2.0.html#derive-attributes">Derive attributes</a></li>
</ul>
</li>
<li><a href="rust/diesel/upgrade-diesel-to-2.0.html#refs">Refs</a></li>
</ul>
<!-- tocstop -->
<h1 id="an-introduction-to-diesel-20"><a class="header" href="#an-introduction-to-diesel-20">An introduction to diesel 2.0</a></h1>
<p>Diesel 2.0 has breaking changes compared to 1.4.x.</p>
<p>Any code base migrating from Diesel 1.4.x to Diesel 2.0 is expected to be affected at least by the following changes:</p>
<ul>
<li><a href="https://diesel.rs/guides/migration_guide.html#2-0-0-mutable-connection">Diesel now requires a mutable reference to the connection</a></li>
<li><a href="https://diesel.rs/guides/migration_guide.html#2-0-0-derive-attributes">Changed derive attributes</a></li>
</ul>
<h1 id="upgrade-to-diesel-20"><a class="header" href="#upgrade-to-diesel-20">Upgrade to diesel 2.0</a></h1>
<h2 id="upgrade-diesel-version-in-cargotoml"><a class="header" href="#upgrade-diesel-version-in-cargotoml">Upgrade diesel version in Cargo.toml</a></h2>
<p>In order to upgrade diesel to 2.0, we need to change dependencies in <code>Cargo.toml</code>.</p>
<pre><code class="language-diff">diff --git a/rust/projects/diesel_2.0_example/Cargo.toml b/rust/projects/diesel_2.0_example/Cargo.toml
index 8f5a1aa..5164334 100644
--- a/rust/projects/diesel_2.0_example/Cargo.toml
+++ b/rust/projects/diesel_2.0_example/Cargo.toml
@@ -5,12 +5,13 @@ authors = ["lichuan &lt;lichuan@mur&gt;"]
 edition = "2018"

 [dependencies]
-diesel = { version = "1.4", features = [
+diesel = { version = "2.1.2", features = [
   "postgres",
   "serde_json",
   "chrono",
   "numeric",
   "64-column-tables",
+  "r2d2",
 ] }
 # r2d2 = "0.8"
 # r2d2-diesel = "1.0"
 dotenv = "0.14"
 # actix-web = "1.0.3"
 chrono = { version = "0.4.7", features = ["serde"] }
</code></pre>
<p>We change diesel version to <code>2.1.2</code> and remove <code>r2d2</code> and <code>r2d2-diesel</code> dependencies, as they are included in <code>diesel</code> crate, by specifying the <code>r2d2</code> feature in <code>diesel</code> crate like this: <code>diesel = { version = "2.1.2", features = [ "r2d2" ] }</code>.</p>
<h2 id="add-mut-to-pgconnection-and-dao-functions"><a class="header" href="#add-mut-to-pgconnection-and-dao-functions">Add mut to PgConnection and dao functions</a></h2>
<p>Diesel now requires mutable access to the Connection to perform any database interaction. The following changes are required for all usages of any Connection type:</p>
<pre><code class="language-diff">- let connection = PgConnection::establish_connection("…")?;
- let result = some_query.load(&amp;connection)?;
+ let mut connection = PgConnection::establish_connection("…")?;
+ let result = some_query.load(&amp;mut connection)?;
</code></pre>
<p>Here are the changes for our own code:</p>
<pre><code class="language-diff">diff --git a/rust/projects/diesel_2.0_example/src/bin/contacts.rs b/rust/projects/diesel_2.0_example/src/bin/contacts.rs
index a74e29397..6efc8ef4f 100644
--- a/rust/projects/diesel_2.0_example/src/bin/contacts.rs
+++ b/rust/projects/diesel_2.0_example/src/bin/contacts.rs
@@ -16,11 +16,15 @@ fn test_contacts() {
         env::var("DATABASE_URL").unwrap_or(LOCAL_DATABASE_URL.into());
     let pool = db::init_pool(database_url);
     // https://github.com/sfackler/r2d2/issues/37
-    let connection = pool.get().unwrap();
+    let mut conn = pool.get().unwrap();

-    let conn: &amp;PgConnection = &amp;connection;
-    conn.execute("TRUNCATE TABLE contacts").unwrap();
-    conn.execute("alter sequence contacts_id_seq restart;").unwrap();
+    diesel::sql_query("TRUNCATE TABLE contacts").execute(&amp;mut conn).unwrap();
+    diesel::sql_query("alter sequence contacts_id_seq restart;")
+        .execute(&amp;mut conn)
+        .unwrap();
+
+    // conn.execute("TRUNCATE TABLE contacts").unwrap();
+    // conn.execute("alter sequence contacts_id_seq restart;").unwrap();

     let santas_address: serde_json::Value = serde_json::from_str(
         r#"{
@@ -61,7 +65,7 @@ fn test_contacts() {
         },
     ];

-    let contacts = create_contracts(&amp;conn, &amp;new_contacts).unwrap();
+    let contacts = create_contracts(&amp;mut conn, &amp;new_contacts).unwrap();
     println!("{:?}", contacts);

     // let inserted_address = insert_into(contacts)
@@ -75,9 +79,7 @@ fn get_contacts() {
     let database_url =
         env::var("DATABASE_URL").unwrap_or(LOCAL_DATABASE_URL.into());
     let pool = db::init_pool(database_url);
-    let connection = pool.get().unwrap();
-
-    let conn: &amp;PgConnection = &amp;connection;
+    let mut conn = pool.get().unwrap();

     let santas_address: serde_json::Value = serde_json::from_str(
         r#"{
@@ -86,12 +88,13 @@ fn get_contacts() {
     )
     .unwrap();

-    let contacts = get_contacts_by_address(&amp;conn, &amp;santas_address).unwrap();
+    let contacts = get_contacts_by_address(&amp;mut conn, &amp;santas_address).unwrap();
     println!("{:?}", contacts);

     let santas_address2: serde_json::Value = json!(true);

-    let contacts = get_contacts_by_address(&amp;conn, &amp;santas_address2).unwrap();
+    let contacts =
+        get_contacts_by_address(&amp;mut conn, &amp;santas_address2).unwrap();
     println!("{:?}", contacts);
 }

diff --git a/rust/projects/diesel_2.0_example/src/bin/select-limit-offset.rs b/rust/projects/diesel_2.0_example/src/bin/select-limit-offset.rs
index a9c583039..a69489b7a 100644
--- a/rust/projects/diesel_2.0_example/src/bin/select-limit-offset.rs
+++ b/rust/projects/diesel_2.0_example/src/bin/select-limit-offset.rs
@@ -10,13 +10,11 @@ fn select_limit_offset() {
         env::var("DATABASE_URL").unwrap_or(local_database_url.into());
     let pool = db::init_pool(database_url);
     // https://github.com/sfackler/r2d2/issues/37
-    let connection = pool.get().unwrap();
-
-    let _conn: &amp;PgConnection = &amp;connection;
+    let mut conn = pool.get().unwrap();

     let limit = 2;
     let offset = 2;
-    let all = get_select_limit_offset(&amp;connection, limit, offset).unwrap();
+    let all = get_select_limit_offset(&amp;mut conn, limit, offset).unwrap();
     println!("select : {:?} records", all);
 }

@@ -26,17 +24,15 @@ fn select_limit_offset_loop() {
         env::var("DATABASE_URL").unwrap_or(local_database_url.into());
     let pool = db::init_pool(database_url);
     // https://github.com/sfackler/r2d2/issues/37
-    let connection = pool.get().unwrap();
-
-    let _conn: &amp;PgConnection = &amp;connection;
+    let mut conn = pool.get().unwrap();

     let limit = 2;
     let mut offset = 0;
-    let all = get_select_limit_offset(&amp;connection, limit, offset).unwrap();
+    let all = get_select_limit_offset(&amp;mut conn, limit, offset).unwrap();
     println!("select : {:?} records", all);

     loop {
-        if let Ok(res) = get_select_limit_offset(&amp;connection, limit, offset) {
+        if let Ok(res) = get_select_limit_offset(&amp;mut conn, limit, offset) {
             if res.len() == 0 {
                 break;
             }
diff --git a/rust/projects/diesel_2.0_example/src/bin/test-connect-r2d2-pool-actix.rs b/rust/projects/diesel_2.0_example/src/bin/test-connect-r2d2-pool-actix.rs
index 1010a2380..44bce1eb4 100644
--- a/rust/projects/diesel_2.0_example/src/bin/test-connect-r2d2-pool-actix.rs
+++ b/rust/projects/diesel_2.0_example/src/bin/test-connect-r2d2-pool-actix.rs
@@ -2,15 +2,22 @@ extern crate diesel;

 use std::env;

-use actix_web::{web, App, HttpRequest, HttpServer, Responder};
+use actix_web::{web, App, HttpServer, Responder};
 use diesel_example::db;

-fn greet(req: HttpRequest) -&gt; impl Responder {
-    let name = req.match_info().get("name").unwrap_or("World");
-    format!("Hello {}!", &amp;name)
+// TODO: why compile error for actix-web 4?
+// fn greet(req: HttpRequest) -&gt; impl Responder {
+//     let name = req.match_info().get("name").unwrap_or("World");
+//     format!("Hello {}!", &amp;name)
+// }
+
+// #[get("/hello/{name}")]
+async fn greet(name: web::Path&lt;String&gt;) -&gt; impl Responder {
+    format!("Hello {}!", name)
 }

-fn main() {
+#[actix_web::main]
+async fn main() -&gt; std::io::Result&lt;()&gt; {
     let database_url = env::var("DATABASE_URL").expect("set DATABASE_URL");
     let pool = db::init_pool(database_url);
     // https://github.com/sfackler/r2d2/issues/37
@@ -26,5 +33,5 @@ fn main() {
     .bind("127.0.0.1:8000")
     .expect("Can not bind to port 8000")
     .run()
-    .unwrap();
+    .await
 }
diff --git a/rust/projects/diesel_2.0_example/src/bin/test-partial-inserts.rs b/rust/projects/diesel_2.0_example/src/bin/test-partial-inserts.rs
index 1819a9677..0fa4e2650 100644
--- a/rust/projects/diesel_2.0_example/src/bin/test-partial-inserts.rs
+++ b/rust/projects/diesel_2.0_example/src/bin/test-partial-inserts.rs
@@ -1,4 +1,3 @@
-
 use diesel_example::dao::partial_inserts::create_partial_inserts;
 use diesel_example::db;
 use diesel_example::model::partial_inserts::NewPartialInsert;
@@ -10,7 +9,7 @@ fn main() {
         env::var("DATABASE_URL").unwrap_or(local_database_url.into());
     let pool = db::init_pool(database_url);
     // https://github.com/sfackler/r2d2/issues/37
-    let connection = pool.get().unwrap();
+    let mut conn = pool.get().unwrap();

     let v = vec![
         NewPartialInsert { user_id: 5, name: Some("3".to_string()) },
@@ -20,7 +19,7 @@ fn main() {
     // 如果每次插入多个，其中一个报错（比如以上 user_id = 2），整体插入失败（5 不被插入）
     // Err(DatabaseError(UniqueViolation, "duplicate key value violates unique constraint \"ui_partial_inserts_user_id\""))

-    let r = create_partial_inserts(&amp;connection, &amp;v);
+    let r = create_partial_inserts(&amp;mut conn, &amp;v);

     println!("{:?}", r);
 }
diff --git a/rust/projects/diesel_2.0_example/src/bin/timestamp-with-zone.rs b/rust/projects/diesel_2.0_example/src/bin/timestamp-with-zone.rs
index e5a793222..1d3b3e72d 100644
--- a/rust/projects/diesel_2.0_example/src/bin/timestamp-with-zone.rs
+++ b/rust/projects/diesel_2.0_example/src/bin/timestamp-with-zone.rs
@@ -1,7 +1,5 @@
-use chrono::{DateTime};
-use diesel_example::dao::timestamp_with_zone::{
-    create_timestamp_with_zones,
-};
+use chrono::DateTime;
+use diesel_example::dao::timestamp_with_zone::create_timestamp_with_zones;
 use diesel_example::db;
 use diesel_example::model::timestamp_with_zone::NewTimestampWithZone;
 use std::env;
@@ -12,7 +10,7 @@ fn main() {
         env::var("DATABASE_URL").unwrap_or(local_database_url.into());
     let pool = db::init_pool(database_url);
     // https://github.com/sfackler/r2d2/issues/37
-    let connection = pool.get().unwrap();
+    let mut conn = pool.get().unwrap();

     /*
         let mut user_id = 123;
@@ -45,7 +43,7 @@ fn main() {
         NewTimestampWithZone { user_id: 109, created_at: dt.into() },
     ];

-    let inserted = create_timestamp_with_zones(&amp;connection, &amp;zones);
+    let inserted = create_timestamp_with_zones(&amp;mut conn, &amp;zones);
     match inserted {
         Ok(ref v) =&gt; {
             println!(
diff --git a/rust/projects/diesel_2.0_example/src/bin/updated-at.rs b/rust/projects/diesel_2.0_example/src/bin/updated-at.rs
index c536b6a9c..27c5a37da 100644
--- a/rust/projects/diesel_2.0_example/src/bin/updated-at.rs
+++ b/rust/projects/diesel_2.0_example/src/bin/updated-at.rs
@@ -10,7 +10,7 @@ fn main() {
         env::var("DATABASE_URL").unwrap_or(local_database_url.into());
     let pool = db::init_pool(database_url);
     // https://github.com/sfackler/r2d2/issues/37
-    let connection = pool.get().unwrap();
+    let mut conn = pool.get().unwrap();

     let user_id = 123;
     let n = NewWeiboFeedCrawlStatus {
@@ -20,11 +20,8 @@ fn main() {
         created_at: Local::now().naive_local(),
         updated_at: None,
     };
-    create_weibo_feed_crawl_status(&amp;connection, &amp;n);
+    create_weibo_feed_crawl_status(&amp;mut conn, &amp;n);
     update_total_page_count_and_next_page_index_by_user_id(
-        user_id,
-        &amp;connection,
-        1,
-        1,
+        user_id, &amp;mut conn, 1, 1,
     );
 }
diff --git a/rust/projects/diesel_2.0_example/src/bin/upsert-if-condition.rs b/rust/projects/diesel_2.0_example/src/bin/upsert-if-condition.rs
index ca7f19d77..807f74272 100644
--- a/rust/projects/diesel_2.0_example/src/bin/upsert-if-condition.rs
+++ b/rust/projects/diesel_2.0_example/src/bin/upsert-if-condition.rs
@@ -10,11 +10,15 @@ fn upsert_on_conflict_id() {
         env::var("DATABASE_URL").unwrap_or(local_database_url.into());
     let pool = db::init_pool(database_url);
     // https://github.com/sfackler/r2d2/issues/37
-    let connection = pool.get().unwrap();
+    let mut conn = pool.get().unwrap();

-    let conn: &amp;PgConnection = &amp;connection;
-    conn.execute("TRUNCATE TABLE upserts_if_condition").unwrap();
-    conn.execute("alter sequence upserts_if_condition_id_seq restart;")
+    // let conn: &amp;mut PgConnection = &amp;mut connection;
+    // conn.execute("TRUNCATE TABLE upserts_if_condition").unwrap();
+    // conn.execute("alter sequence upserts_if_condition_id_seq restart;")
+    //     .unwrap();
+
+    diesel::sql_query("TRUNCATE TABLE upserts_if_condition")
+        .execute(&amp;mut conn)
         .unwrap();

     let u = NewUpsertIfCondition {
@@ -27,7 +31,7 @@ fn upsert_on_conflict_id() {
         next: Some(9),
         email: Some("e".into()),
     };
-    let inserted = create_upserts_if_condition_by_sql(&amp;connection, &amp;u).unwrap();
+    let inserted = create_upserts_if_condition_by_sql(&amp;mut conn, &amp;u).unwrap();
     println!("{} records inserted", inserted.len());
 }
</code></pre>
<h2 id="derive-attributes"><a class="header" href="#derive-attributes">Derive attributes</a></h2>
<p>You should add <code>#[diesel()]</code> when using derive attributes.</p>
<p>Below is an example of using <code>table_name</code> macro to define <code>NewTimestampWithZone</code> struct.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Insertable, Debug)]
// NOTE: For diesel 1.4.x, we use `table_name` macro directly.
// #[table_name = "timestamp_with_zone"]
#[table_name = "timestamp_with_zone"]
pub struct NewTimestampWithZone {
    pub user_id: i64,
    pub created_at: DateTime&lt;Utc&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h1 id="refs"><a class="header" href="#refs">Refs</a></h1>
<p>Diesel 2.0 migration guide
https://diesel.rs/guides/migration_guide.html</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="table-of-contents-5"><a class="header" href="#table-of-contents-5">Table of Contents</a></h1>
<!--ts-->
<ul>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#add-dependency-in-go-mod-in-self-hosted-gitlab">Add dependency in go mod in self-hosted gitlab</a>
<ul>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#background">Background</a></li>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#how-go-get-works">How go get works?</a></li>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#fix">Fix</a>
<ul>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#use-nginx">Use nginx</a></li>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#use-caddy">Use caddy</a></li>
</ul>
</li>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#config-ssh">Config ssh</a></li>
</ul>
</li>
</ul>
<!--te-->
<h1 id="add-dependency-in-go-mod-in-self-hosted-gitlab"><a class="header" href="#add-dependency-in-go-mod-in-self-hosted-gitlab">Add dependency in go mod in self-hosted gitlab</a></h1>
<h2 id="background"><a class="header" href="#background">Background</a></h2>
<p>As an infrastructure engineer, it is common to deploy source code management tools like GitLab to management source code. When using GitLab for code management, we need to add dependencies to our projects like this:</p>
<pre><code class="language-bash">go get -u -v gitlab.mycompany.com/mygroup/myproject
</code></pre>
<p>If we're using github, running <code>go get github.com/username/repo</code> will succeed. Here is an example:</p>
<pre><code class="language-bash">go get -u -v github.com/lichuan6/go-mod-test
</code></pre>
<p>Output:</p>
<pre><code>go: downloading github.com/lichuan6/go-mod-test v1.0.1
go: added github.com/lichuan6/go-mod-test v1.0.1
</code></pre>
<p>However, it fails with self-hosted VCS like gitlab:</p>
<pre><code class="language-bash">go get gitlab.mycompany.com/mygroup/myproject
</code></pre>
<p>Output:</p>
<pre><code>go: unrecognized import path "gitlab.mycompany.com/mygroup/myproject": parse https://gitlab.mycompany.com/mygroup/myproject?go-get=1: no go-import meta tags (meta tag gitlab.mycompany.com:443/mygroup/myproject did not match import path gitlab.mycompany.com/mygroup/myproject)
</code></pre>
<p>What does this error message mean?</p>
<h2 id="how-go-get-works"><a class="header" href="#how-go-get-works">How go get works?</a></h2>
<p>Before digging into the reason why it failed, we need to understand how <code>go get</code> works.</p>
<p>The <a href="https://docs.gitlab.com/ee/development/go_guide/dependencies.html">gitlab document</a> says that prior to Go 1.12, the process for fetching a package was as follows:</p>
<ul>
<li>Query <code>https://{package name}?go-get=1</code>.</li>
<li>Scan the response for the <code>go-import</code> meta tag.</li>
<li>Fetch the repository indicated by the meta tag using the indicated VCS.</li>
</ul>
<p>The meta tag should have the form <code>&lt;meta name="go-import" content="{prefix} {vcs} {url}"&gt;</code>. For example, <code>gitlab.com/my/project git https://gitlab.com/my/project.git</code> indicates that packages beginning with <code>gitlab.com/my/project</code> should be fetched from <code>https://gitlab.com/my/project.git</code> using Git.</p>
<p>Looking back the error message, we know that we do not config correct meta tag for request like <code>https://{package name}?go-get=1</code>, here it refers to <code>https://gitlab.mycompany.com/mygroup/myproject</code>.</p>
<h2 id="fix"><a class="header" href="#fix">Fix</a></h2>
<p>The fix is easy, but it maybe different depending on which reverse proxy you use.</p>
<h3 id="use-nginx"><a class="header" href="#use-nginx">Use nginx</a></h3>
<p>If you're using <code>nginx</code>, you can add the following config to nginx configuration:</p>
<pre><code>server {
    server_name gitlab.mycompany.com;

    if ($args ~* "^go-get=1") {
      set $condition goget;
    }
    if ($uri ~ ^/([a-zA-Z0-9\._-]+)/([a-zA-Z0-9_-]+)/?.*$) {
      set $condition "${condition}query";
    }
    if ($condition = gogetquery) {
      return 200 "&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta content='gitlab.mycompany.com/$1/$2 git https://gitlab.mycompany.com
/$1/$2' name='go-import'&gt;&lt;/head&gt;&lt;/html&gt;";
    }
}
</code></pre>
<h3 id="use-caddy"><a class="header" href="#use-caddy">Use caddy</a></h3>
<p>If you're using <code>caddy</code>, you can add the following config to <code>Caddyfile</code>:</p>
<pre><code>gitlab.mycompany.com {
        @goget {
                path_regexp goget ^/([a-zA-Z0-9\._-]+)/([a-zA-Z0-9_-]+)$
                query go-get=1
        }

        respond @goget 200 {
                body "&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta content='gitlab.mycompany.com/{re.goget.1}/{re.goget.2} git ssh://git@gitlab.mycompany.com/{re.goget.1}/{re.goget.2}' name='go-import'&gt;&lt;/head&gt;&lt;/html&gt;"
        }

        reverse_proxy localhost:10080
}
</code></pre>
<h2 id="config-ssh"><a class="header" href="#config-ssh">Config ssh</a></h2>
<p>Now we have reverse proxy configured to return the correct meta tag in response, but there's still an error when running <code>go get -u -v gitlab.mycompany.com/mygroup/myproject</code>:</p>
<pre><code>get "gitlab.mycompany.com/mygroup/myproject": found meta tag vcs.metaImport{Prefix:"gitlab.mycompany.com/mygroup/myproject", VCS:"git", RepoRoot:"ssh://git@gitlab.mycompany.com/mygroup/myproject"} at //gitlab.mycompany.com/mygroup/myproject?go-get=1
go: module gitlab.mycompany.com/mygroup/myproject: git ls-remote -q origin in /Users/username/go/pkg/mod/cache/vcs/d831e72abb0cb1006afb601471112319e0a1d0e490efb16e63a5682d76677a2e: exit status 128:
        Host key verification failed.
        fatal: Could not read from remote repository.

        Please make sure you have the correct access rights
        and the repository exists.
</code></pre>
<p>You need to add the following to ssh config file: <code>~/.ssh/config</code>, which means it wil tell go get to use the correct identity file to fetch the package from gitlab:</p>
<pre><code>Host gitlab.mycompany.com
    # ssh://git@gitlab.mycompany.com/username/project.git
    Port 10022
    User git
    #IdentityFile ~/.ssh/id_rsa.gitlab.self-hosted
    IdentityFile ~/.ssh/id_rsa-gitlab.self-hosted
</code></pre>
<p>After all is setup, you can add dependency using <code>go get</code> successfully.</p>
<pre><code>get "gitlab.mycompany.com/mygroup/myproject": found meta tag vcs.metaImport{Prefix:"gitlab.mycompany.com/mygroup/myproject", VCS:"git", RepoRoot:"ssh://git@gitlab.mycompany.com/mygroup/myproject"} at //gitlab.mycompany.com/mygroup/myproject?go-get=1
go: added gitlab.mycompany.com/mygroup/myproject v0.0.1
</code></pre>
<p>🎉🎉🎉</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="add-nextjs-router-to-mui-tabs"><a class="header" href="#add-nextjs-router-to-mui-tabs">Add nextjs router to mui tabs</a></h1>
<h1 id="table-of-contents-6"><a class="header" href="#table-of-contents-6">Table of Contents</a></h1>
<!--ts-->
<ul>
<li><a href="nextjs/add-nextjs-router-to-mui-tabs.html#add-nextjs-router-to-mui-tabs">Add nextjs router to mui tabs</a></li>
<li><a href="nextjs/add-nextjs-router-to-mui-tabs.html#table-of-contents">Table of Contents</a></li>
<li><a href="nextjs/add-nextjs-router-to-mui-tabs.html#introduction">Introduction</a></li>
<li><a href="nextjs/add-nextjs-router-to-mui-tabs.html#demoseeing-is-beliving">Demo(Seeing is beliving)</a></li>
<li><a href="nextjs/add-nextjs-router-to-mui-tabs.html#application-structure">Application structure</a></li>
<li><a href="nextjs/add-nextjs-router-to-mui-tabs.html#proceedstabs-component">ProceedsTabs component</a></li>
<li><a href="nextjs/add-nextjs-router-to-mui-tabs.html#tab-page">Tab page</a></li>
<li><a href="nextjs/add-nextjs-router-to-mui-tabs.html#proceeds-page">Proceeds page</a></li>
<li><a href="nextjs/add-nextjs-router-to-mui-tabs.html#the-takeaway">The takeaway</a></li>
<li><a href="nextjs/add-nextjs-router-to-mui-tabs.html#summary">Summary</a></li>
</ul>
<!--te-->
<h1 id="introduction-1"><a class="header" href="#introduction-1">Introduction</a></h1>
<p>In this blog post, we will explore how to build a tabbed navigation system in <code>Next.js</code> using <code>React</code>. Tabbed navigation is a common UI pattern that allows users to switch between different sections or categories of content within a single page.</p>
<h1 id="demoseeing-is-beliving"><a class="header" href="#demoseeing-is-beliving">Demo(Seeing is beliving)</a></h1>
<p><img src="https://user-images.githubusercontent.com/74223747/264132025-57ca0731-46dd-4208-95ca-74420ff60e38.gif" alt="" /></p>
<h1 id="application-structure"><a class="header" href="#application-structure">Application structure</a></h1>
<p>The Next.js App Router is a file-system based router built on concepts of pages.</p>
<p>Now, I will show you how to use Material UI with the Next.js App Router.</p>
<p>The structure of <code>src</code> folder looks like this:</p>
<pre><code>drwxr-xr-x     - naonao 28 Aug 16:38 src
drwxr-xr-x     - naonao 28 Aug 23:38 ├── app
.rw-r--r--  4.1k naonao 28 Aug 23:51 │  ├── layout.tsx
.rw-r--r--  3.2k naonao 28 Aug 16:38 │  ├── page.tsx
drwxr-xr-x     - naonao 28 Aug 23:59 │  ├── proceeds
drwxr-xr-x     - naonao 28 Aug 23:57 │  │  ├── category
.rw-r--r--   419 naonao 28 Aug 23:58 │  │  │  └── page.tsx
drwxr-xr-x     - naonao 28 Aug 23:59 │  │  ├── client
.rw-r--r--   415 naonao 28 Aug 23:59 │  │  │  └── page.tsx
drwxr-xr-x     - naonao 28 Aug 23:58 │  │  ├── cmb
.rw-r--r--   409 naonao 28 Aug 23:59 │  │  │  └── page.tsx
drwxr-xr-x     - naonao 28 Aug 23:38 │  │  ├── content
.rw-r--r--   418 naonao 28 Aug 23:48 │  │  │  └── page.tsx
drwxr-xr-x     - naonao 28 Aug 23:58 │  │  ├── contenttype
.rw-r--r--   425 naonao 28 Aug 23:58 │  │  │  └── page.tsx
drwxr-xr-x     - naonao 28 Aug 23:49 │  │  ├── device
.rw-r--r--   415 naonao 28 Aug 23:57 │  │  │  └── page.tsx
.rw-r--r--   749 naonao 28 Aug 23:56 │  │  ├── page.tsx
drwxr-xr-x     - naonao 28 Aug 23:48 │  │  ├── territory
.rw-r--r--   424 naonao 28 Aug 23:49 │  │  │  └── page.tsx
drwxr-xr-x     - naonao 28 Aug 23:58 │  │  ├── transactiontype
.rw-r--r--   433 naonao 29 Aug 00:00 │  │  │  └── page.tsx
drwxr-xr-x     - naonao 28 Aug 23:59 │  │  └── version
.rw-r--r--   417 naonao 28 Aug 23:59 │  │     └── page.tsx
drwxr-xr-x     - naonao 28 Aug 23:40 └── components
.rw-r--r--  3.5k naonao 29 Aug 00:01    ├── ProceedsTabs.tsx
drwxr-xr-x     - naonao 28 Aug 16:38    └── ThemeRegistry
.rw-r--r--  2.9k naonao 28 Aug 16:38       ├── EmotionCache.tsx
.rw-r--r--   590 naonao 28 Aug 16:38       ├── theme.ts
.rw-r--r--   647 naonao 28 Aug 16:38       └── ThemeRegistry.tsx
</code></pre>
<p>We add a <code>proceeds</code> folder in <code>app</code>, we also add corresponding folder as router in <code>provided</code> to represent each tab.</p>
<h1 id="proceedstabs-component"><a class="header" href="#proceedstabs-component">ProceedsTabs component</a></h1>
<p>Let's look at the <code>ProceedsTabs</code> component.</p>
<pre><code class="language-jsx">"use client";

import * as React from "react";
import Tabs from "@mui/material/Tabs";
import Tab from "@mui/material/Tab";
import Typography from "@mui/material/Typography";
import Box from "@mui/material/Box";
import { useRouter } from "next/navigation";

interface ProceedsTabsProps {
  defaultTab: number;
}

const ProceedsTabs: React.FC&lt;ProceedsTabsProps&gt; = ({ defaultTab }) =&gt; {
  const router = useRouter();
  const [value, setValue] = React.useState(defaultTab);

  const handleChange = (event: React.SyntheticEvent, newValue: number) =&gt; {
    setValue(newValue);
  };

  React.useEffect(() =&gt; {
    let route = "/proceeds";
    if (value === 0) {
      route += "/content";
    } else if (value === 1) {
      route += "/territory";
    } else if (value === 2) {
      route += "/device";
    } else if (value === 3) {
      route += "/category";
    } else if (value === 4) {
      route += "/contenttype";
    } else if (value === 5) {
      route += "/transactiontype";
    } else if (value === 6) {
      route += "/cmb";
    } else if (value === 7) {
      route += "/version";
    } else if (value === 8) {
      route += "/client";
    }
    console.log(`💗💗💗 ${route}`);
    router.push(route);
  }, [value]);

  return (
    &lt;Box sx={{ width: "100%" }}&gt;
      &lt;Box sx={{ borderBottom: 1, borderColor: "divider" }}&gt;
        &lt;Tabs value={value} onChange={handleChange} aria-label="proceeds tabs"&gt;
          &lt;Tab label="Content" /&gt;
          &lt;Tab label="Territory" /&gt;
          &lt;Tab label="Device" /&gt;
          &lt;Tab label="Category" /&gt;
          &lt;Tab label="Content Type" /&gt;
          &lt;Tab label="Transaction Type" /&gt;
          &lt;Tab label="CMB" /&gt;
          &lt;Tab label="Version" /&gt;
          &lt;Tab label="Client" /&gt;
        &lt;/Tabs&gt;
      &lt;/Box&gt;
      &lt;div role="tabpanel" hidden={value !== 0}&gt;
        {value === 0 &amp;&amp; (
          &lt;Box sx={{ p: 3 }}&gt;
            &lt;Typography&gt;Content&lt;/Typography&gt;
          &lt;/Box&gt;
        )}
      &lt;/div&gt;
      &lt;div role="tabpanel" hidden={value !== 1}&gt;
        {value === 1 &amp;&amp; (
          &lt;Box sx={{ p: 3 }}&gt;
            &lt;Typography&gt;Territory&lt;/Typography&gt;
          &lt;/Box&gt;
        )}
      &lt;/div&gt;
      &lt;div role="tabpanel" hidden={value !== 2}&gt;
        {value === 2 &amp;&amp; (
          &lt;Box sx={{ p: 3 }}&gt;
            &lt;Typography&gt;Device&lt;/Typography&gt;
          &lt;/Box&gt;
        )}
      &lt;/div&gt;
      &lt;div role="tabpanel" hidden={value !== 3}&gt;
        {value === 3 &amp;&amp; (
          &lt;Box sx={{ p: 3 }}&gt;
            &lt;Typography&gt;Category&lt;/Typography&gt;
          &lt;/Box&gt;
        )}
      &lt;/div&gt;
      &lt;div role="tabpanel" hidden={value !== 4}&gt;
        {value === 4 &amp;&amp; (
          &lt;Box sx={{ p: 3 }}&gt;
            &lt;Typography&gt;Content Type&lt;/Typography&gt;
          &lt;/Box&gt;
        )}
      &lt;/div&gt;
      &lt;div role="tabpanel" hidden={value !== 5}&gt;
        {value === 5 &amp;&amp; (
          &lt;Box sx={{ p: 3 }}&gt;
            &lt;Typography&gt;Transaction Type&lt;/Typography&gt;
          &lt;/Box&gt;
        )}
      &lt;/div&gt;
      &lt;div role="tabpanel" hidden={value !== 6}&gt;
        {value === 6 &amp;&amp; (
          &lt;Box sx={{ p: 3 }}&gt;
            &lt;Typography&gt;CMB&lt;/Typography&gt;
          &lt;/Box&gt;
        )}
      &lt;/div&gt;
      &lt;div role="tabpanel" hidden={value !== 7}&gt;
        {value === 7 &amp;&amp; (
          &lt;Box sx={{ p: 3 }}&gt;
            &lt;Typography&gt;Version&lt;/Typography&gt;
          &lt;/Box&gt;
        )}
      &lt;/div&gt;
      &lt;div role="tabpanel" hidden={value !== 8}&gt;
        {value === 8 &amp;&amp; (
          &lt;Box sx={{ p: 3 }}&gt;
            &lt;Typography&gt;Client&lt;/Typography&gt;
          &lt;/Box&gt;
        )}
      &lt;/div&gt;
    &lt;/Box&gt;
  );
};

export default ProceedsTabs;
</code></pre>
<p><code>ProceedsTabs</code> React functional component that represents a tabbed navigation system for managing different types of proceeds.</p>
<p>First, it imports various dependencies from the Material-UI library, such as <code>Tabs</code>, <code>Tab</code>, <code>Typography</code>, and <code>Box</code>. It also imports the <code>useRouter</code> hook for handling navigation.</p>
<p>It takes a single prop named <code>defaultTab</code>, which determines the initially selected tab. Inside the component, it initializes the value state variable using the <code>useState</code> hook, with the initial value set to <code>defaultTab</code>.</p>
<p>This component also defines a <code>handleChange</code> function that is called when the user selects a different tab. This function updates the value state variable with the new tab index.</p>
<p>Besides, it also uses the <code>useEffect</code> hook to listen for changes in the value state variable. When the value changes, it constructs a route string based on the selected tab index and pushes the new route to the router using the <code>router.push</code> method.</p>
<p>For the rendering, it uses a <code>Box</code> component with a width of 100% to contain the tab navigation. Inside the <code>Box</code>, there is a <code>Tabs</code> component that renders the individual tabs based on the value state variable and the <code>handleChange</code> function.</p>
<p>Below the Tabs component, there are multiple div elements that represent the content for each tab. The <code>hidden</code> attribute is used to show or hide the content based on the selected tab. Each div element contains a <code>Box</code> component with some padding and a <code>Typography</code> component that displays the name of the tab, just for demostration. Feel free to use your own component for each tab.</p>
<h1 id="tab-page"><a class="header" href="#tab-page">Tab page</a></h1>
<p>Now, let's look at each tab page.</p>
<p>As most tab pages are the same, we will take <code>category</code> as an example.</p>
<pre><code class="language-jsx">"use client";

import ProceedsTabs from "@/components/ProceedsTabs";

const Category = () =&gt; {
  let defaultTab = 3;
  return &lt;ProceedsTabs defaultTab={defaultTab} /&gt;;
};

export default Category;
</code></pre>
<p>We write a React functional component named <code>Category</code>. This component is responsible for rendering a specific category page for proceeds.</p>
<p>It imports the <code>ProceedsTabs</code> component from the <code>@/components/ProceedsTabs</code> and pass <code>defaultTab</code> to specify which tab to render.</p>
<h1 id="proceeds-page"><a class="header" href="#proceeds-page">Proceeds page</a></h1>
<p>Now, let's look at the <code>proceeds</code> page.</p>
<pre><code class="language-jsx">"use client";

import { useRouter, useSearchParams } from "next/navigation";
import ProceedsTabs from "@/components/ProceedsTabs";

const Proceeds = () =&gt; {
  const router = useRouter();
  const searchParams = useSearchParams();
  const tab = searchParams.get("tab");

  let defaultTab = 0;

  if (tab === "/content") {
    defaultTab = 0;
  } else if (tab === "/territory") {
    defaultTab = 1;
  } else if (tab === "/device") {
    defaultTab = 2;
  } else if (tab === "/category") {
    defaultTab = 3;
  } else if (tab === "/contenttype";) {
    defaultTab = 4;
  } else if (tab === "/transactiontype") {
    defaultTab = 5;
  } else if (tab === "/cmb") {
    defaultTab = 6;
  } else if (tab === "/version") {
    defaultTab = 7;
  } else if (tab === "/client") {
    defaultTab = 8;
  }

  return &lt;ProceedsTabs defaultTab={defaultTab} /&gt;;
};

export default Proceeds;
</code></pre>
<p>This component uses the <code>useSearchParams</code> hook to access the search parameters from the URL. It retrieves the value of the tab parameter using the <code>searchParams.get("tab")</code> method and assigns it to the tab variable.</p>
<p>After that, there is a series of conditional statements that determine the value of the <code>defaultTab</code> variable based on the value of the tab variable. If the tab is <code>"territory"</code>, the <code>defaultTab</code> is set to <code>1</code>. If the tab is <code>"device"</code>, the <code>defaultTab</code> is set to <code>2</code>, etc.</p>
<p>As we handle request parameter using <code>useSearchParams</code> hook and pass tab index to <code>ProceedsTabs</code> which will push corresponding route using <code>router.push(route)</code>, when we open link like <code>http://localhost:3000/proceeds?tab=content</code>, the browser will redirect to <code>http://localhost:3000/proceed/content</code>.</p>
<h1 id="the-takeaway"><a class="header" href="#the-takeaway">The takeaway</a></h1>
<p>Follow these steps if you want to implement tabbed navigation using NextJS:</p>
<ul>
<li>Define correct file system structure(page files) to represent router</li>
<li>Write tab component(<code>ProceedsTabs</code>) to conditionally render tab based on tab index
<ul>
<li>Handling Tab Changes to update router</li>
<li>Updating the URL when state(selected tab) changes and push new route</li>
<li>Rendering the Tabs based on tab index</li>
</ul>
</li>
<li>Write each individual tab page as nextjs route need it</li>
</ul>
<h1 id="summary-1"><a class="header" href="#summary-1">Summary</a></h1>
<p>In this blog post, we have explored how to build a tabbed navigation system in Next.js using React. We have seen how to handle tab changes, update the URL, and render the tab content dynamically. By leveraging the power of Next.js and React, we can create a flexible and interactive tabbed navigation component that enhances the user experience of our web applications.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="table-of-contents-7"><a class="header" href="#table-of-contents-7">Table of Contents</a></h1>
<!--ts-->
<ul>
<li><a href="nodejs/test/setup-tests-in-npm-project-using-jest.html#setup-tests-in-npm-project-using-jest">Setup tests in npm project using jest</a></li>
<li><a href="nodejs/test/setup-tests-in-npm-project-using-jest.html#init-nodejs-project-using-npm">Init nodejs project using npm</a></li>
<li><a href="nodejs/test/setup-tests-in-npm-project-using-jest.html#install-jest">Install jest</a></li>
<li><a href="nodejs/test/setup-tests-in-npm-project-using-jest.html#install-other-dependencies">Install other dependencies</a></li>
<li><a href="nodejs/test/setup-tests-in-npm-project-using-jest.html#write-functions">Write functions</a></li>
<li><a href="nodejs/test/setup-tests-in-npm-project-using-jest.html#write-tests-for-functions">Write tests for functions</a></li>
<li><a href="nodejs/test/setup-tests-in-npm-project-using-jest.html#run-test">Run Test</a></li>
</ul>
<!--te-->
<h1 id="setup-tests-in-npm-project-using-jest"><a class="header" href="#setup-tests-in-npm-project-using-jest">Setup tests in npm project using jest</a></h1>
<p>In this article, I will demonstrate how to set up <code>Jest</code>, a popular testing framework, to run tests in a Node.js project. I will guide you through the process of installing Jest, configuring it for your project, and running sample tests to ensure everything is set up correctly. By the end of this article, you will have a fully functional Jest setup for testing your Node.js code.</p>
<h1 id="init-nodejs-project-using-npm"><a class="header" href="#init-nodejs-project-using-npm">Init nodejs project using npm</a></h1>
<p>First, let's set up a Node.js project to organize the code. We will use npm to initialize the project by running the command <code>npm init</code> in your project's root directory.</p>
<pre><code class="language-bash">mkdir -p npm-test; cd npm-test; npm init --yes
</code></pre>
<p>The <code>--yes</code> flag is used to automatically accept the default values for all prompts. This will generate a package.json file with default values for the package name, version, description, entry point, test command, repository, author, and license.</p>
<p>Output:</p>
<pre><code>Wrote to /Users/naonao/tmp/kkkk/npm-test/package.json:

{
  "name": "npm-test",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}
</code></pre>
<h1 id="install-jest"><a class="header" href="#install-jest">Install jest</a></h1>
<p><a href="https://jestjs.io/">Jest</a> is a popular JavaScript testing framework developed by Facebook.</p>
<blockquote>
<p>Jest is a delightful JavaScript Testing Framework with a focus on simplicity.</p>
</blockquote>
<p>It provides a complete solution for running tests, making assertions, mocking dependencies, and generating code coverage reports. Jest's key features include a descriptive syntax, a wide range of built-in matchers, support for snapshot testing, simplified testing of asynchronous code, and extensive configuration options. It is widely used and highly regarded for its simplicity, comprehensive documentation, and powerful testing capabilities</p>
<pre><code class="language-bash">npm install --save-dev jest
</code></pre>
<h1 id="install-other-dependencies"><a class="header" href="#install-other-dependencies">Install other dependencies</a></h1>
<p>We can install any dependencies using <code>npm install &lt;library&gt;</code>. Below is an example of adding <code>dayjs</code> as dependency.</p>
<pre><code class="language-bash">npm install dayjs
</code></pre>
<h1 id="write-functions"><a class="header" href="#write-functions">Write functions</a></h1>
<p>Now, we'll write a function to convert different relative time formats (<code>now-15m</code>, <code>now-1h</code>, <code>now-24h</code>, <code>now-7h</code>) to their respective absolute time representations. The function looks like this:</p>
<pre><code class="language-javascript">const dayjs = require("dayjs");

const getAbsoluteTime = (relativeTime) =&gt; {
  if (relativeTime.includes("now")) {
    let parsedDate = dayjs();

    if (relativeTime.includes("m")) {
      const relativeValue = parseInt(
        relativeTime.split("now-")[1].split("m")[0]
      );
      parsedDate = parsedDate.subtract(relativeValue, "minute");
    } else if (relativeTime.includes("h")) {
      const relativeValue = parseInt(
        relativeTime.split("now-")[1].split("h")[0]
      );
      parsedDate = parsedDate.subtract(relativeValue, "hour");
    } else if (relativeTime.includes("d")) {
      const relativeValue = parseInt(
        relativeTime.split("now-")[1].split("d")[0]
      );
      parsedDate = parsedDate.subtract(relativeValue, "day");
    }

    return parsedDate.format("YYYY-MM-DDTHH:mm");
  }

  return null;
};

module.exports = getAbsoluteTime;
</code></pre>
<p>We'll save it in <code>getAbsoluteTime.js</code> file in the project's root directory.</p>
<h1 id="write-tests-for-functions"><a class="header" href="#write-tests-for-functions">Write tests for functions</a></h1>
<p>Now, let's write tests for this simple function.</p>
<pre><code class="language-javascript">const dayjs = require("dayjs");
const getAbsoluteTime = require("../getAbsoluteTime"); // Assuming the function is exported from a separate file

describe("getAbsoluteTime", () =&gt; {
  it('should return the correct absolute time for relative time "now-15m"', () =&gt; {
    const relativeTime = "now-15m";
    const absoluteTime = getAbsoluteTime(relativeTime);
    const currentTime = dayjs(); // Get the current time using dayjs
    const expectedTime = currentTime
      .subtract(15, "minute")
      .format("YYYY-MM-DDTHH:mm");
    expect(absoluteTime).toBe(expectedTime);
  });

  it('should return the correct absolute time for relative time "now-1h"', () =&gt; {
    const relativeTime = "now-1h";
    const absoluteTime = getAbsoluteTime(relativeTime);
    const currentTime = dayjs(); // Get the current time using dayjs
    const expectedTime = currentTime
      .subtract(1, "hour")
      .format("YYYY-MM-DDTHH:mm");
    expect(absoluteTime).toBe(expectedTime);
  });

  it('should return the correct absolute time for relative time "now-24h"', () =&gt; {
    const relativeTime = "now-24h";
    const absoluteTime = getAbsoluteTime(relativeTime);
    const currentTime = dayjs(); // Get the current time using dayjs
    const expectedTime = currentTime
      .subtract(24, "hour")
      .format("YYYY-MM-DDTHH:mm");
    expect(absoluteTime).toBe(expectedTime);
  });

  it('should return the correct absolute time for relative time "now-7h"', () =&gt; {
    const relativeTime = "now-7h";
    const absoluteTime = getAbsoluteTime(relativeTime);
    const currentTime = dayjs(); // Get the current time using dayjs
    const expectedTime = currentTime
      .subtract(7, "hour")
      .format("YYYY-MM-DDTHH:mm");
    expect(absoluteTime).toBe(expectedTime);
  });
});
</code></pre>
<p>Save this file in <code>tests/getAbsoluteTime.test.js</code> and we are ready to run test using <code>jest</code>.</p>
<h1 id="run-test"><a class="header" href="#run-test">Run Test</a></h1>
<p>Before running any tests, you have to add <code>"scripts" : {"test": "jest"}</code> to <code>package.json</code> as follows:</p>
<pre><code class="language-json">{
  // ...
  "scripts": {
    "test": "jest"
  }
  // ...
}
</code></pre>
<p>Now, you can run tests using <code>npm run test</code> command.</p>
<p>Output:</p>
<pre><code class="language-bash">&gt; relative-time-to-absolute-time@1.0.0 test
&gt; jest

 PASS  tests/getAbsoluteTime.test.js
  getAbsoluteTime
    ✓ should return the correct absolute time for relative time "now-15m" (2 ms)
    ✓ should return the correct absolute time for relative time "now-1h"
    ✓ should return the correct absolute time for relative time "now-24h" (1 ms)
    ✓ should return the correct absolute time for relative time "now-7h"

Test Suites: 1 passed, 1 total
Tests:       4 passed, 4 total
Snapshots:   0 total
Time:        0.149 s, estimated 1 s
Ran all test suites.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="update-on-local-table-for-replicatedmergetree-table-engine"><a class="header" href="#update-on-local-table-for-replicatedmergetree-table-engine">Update on local table for ReplicatedMergeTree Table Engine</a></h1>
<!-- toc -->
<ul>
<li><a href="clickhouse/update/update-on-local-table-for-replicatedmergetree-table-engine.html#create-local-and-distributed-table">Create Local and Distributed Table</a></li>
<li><a href="clickhouse/update/update-on-local-table-for-replicatedmergetree-table-engine.html#insert-data">Insert Data</a></li>
<li><a href="clickhouse/update/update-on-local-table-for-replicatedmergetree-table-engine.html#%E2%9D%8Cupdate-on-distributed-table-engine">❌Update on Distributed Table Engine</a></li>
<li><a href="clickhouse/update/update-on-local-table-for-replicatedmergetree-table-engine.html#%E2%9C%85update-on-local-table-engine">✅Update on Local Table Engine</a></li>
<li><a href="clickhouse/update/update-on-local-table-for-replicatedmergetree-table-engine.html#refs">Refs</a></li>
</ul>
<!-- tocstop -->
<h1 id="create-local-and-distributed-table"><a class="header" href="#create-local-and-distributed-table">Create Local and Distributed Table</a></h1>
<pre><code class="language-sql">-- Create Local Table
CREATE TABLE t.t_local ON CLUSTER `{cluster}` (
    timestamp DateTime Codec(DoubleDelta, LZ4),
    log String,
    path String
)
ENGINE = ReplicatedMergeTree(
  '/clickhouse/{installation}/{cluster}/tables/{shard}/{database}/{table}', '{replica}'
)
PARTITION BY toYYYYMM(timestamp)
ORDER BY (timestamp, path)

-- Create Distributed Table
CREATE TABLE t.t_all ON CLUSTER `{cluster}`
ENGINE = Distributed('{cluster}', t, t_local, rand())
</code></pre>
<h1 id="insert-data"><a class="header" href="#insert-data">Insert Data</a></h1>
<p>Insert data through local table:</p>
<p>NOTE: Run each sql line in <code>clickhouse-client</code> prompt, otherwise only one record is inserted.</p>
<pre><code class="language-sql">INSERT INTO t.t_local (timestamp, log, path) VALUES ('2023-10-17 09:00:00', 'First log entry', '/var/logs/file1.log');
INSERT INTO t.t_local (timestamp, log, path) VALUES ('2023-10-17 10:30:00', 'Second log entry', '/var/logs/file2.log');
INSERT INTO t.t_local (timestamp, log, path) VALUES ('2023-10-17 12:15:00', 'Third log entry', '/var/logs/file3.log');
</code></pre>
<p>Insert data through distributed table:</p>
<pre><code class="language-sql">INSERT INTO t.t_all (timestamp, log, path) VALUES ('2023-10-18 09:00:00', 'First log entry', '/var/logs/file1.log');
INSERT INTO t.t_all (timestamp, log, path) VALUES ('2023-10-18 10:30:00', 'Second log entry', '/var/logs/file2.log');
INSERT INTO t.t_all (timestamp, log, path) VALUES ('2023-10-18 12:15:00', 'Third log entry', '/var/logs/file3.log');
</code></pre>
<h1 id="update-on-distributed-table-engine"><a class="header" href="#update-on-distributed-table-engine">❌Update on Distributed Table Engine</a></h1>
<pre><code class="language-sql">ALTER TABLE t.t_all UPDATE log = 'Updated log entry &lt;-'
WHERE timestamp = '2023-10-17 09:00:00' AND path = '/var/logs/file1.log';
</code></pre>
<p>Error:</p>
<pre><code class="language-sql">ALTER TABLE t.t_all
    UPDATE log = 'Updated log entry &lt;-' WHERE (timestamp = '2023-10-17 09:00:00') AND (path = '/var/logs/file1.log')

Query id: fcd17813-087c-496b-ba2e-0e5c7fbff6ea


0 rows in set. Elapsed: 0.019 sec.

Received exception from server (version 23.3.8):
Code: 48. DB::Exception: Received from localhost:9000. DB::Exception: Table engine Distributed doesn't support mutations. (NOT_IMPLEMENTED)

</code></pre>
<h1 id="update-on-local-table-engine"><a class="header" href="#update-on-local-table-engine">✅Update on Local Table Engine</a></h1>
<p>Let's update data through local table(non-distributed table):</p>
<pre><code class="language-sql">ALTER TABLE t.t_local ON CLUSTER `{cluster}` UPDATE log = 'Updated log entry &lt;-'
WHERE timestamp = '2023-10-17 09:00:00' AND path = '/var/logs/file1.log';
</code></pre>
<p>Results:</p>
<pre><code class="language-sql">ALTER TABLE t.t_local ON CLUSTER `{cluster}`
    UPDATE log = 'Updated log entry &lt;-' WHERE (timestamp = '2023-10-17 09:00:00') AND (path = '/var/logs/file1.log')

Query id: 0a119cbf-d244-4d3c-be12-be7201d25d6c

┌─host──────────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ chi-logs-logs-1-1 │ 9000 │      0 │       │                   3 │                0 │
│ chi-logs-logs-0-0 │ 9000 │      0 │       │                   2 │                0 │
│ chi-logs-logs-0-1 │ 9000 │      0 │       │                   1 │                0 │
│ chi-logs-logs-1-0 │ 9000 │      0 │       │                   0 │                0 │
└───────────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

4 rows in set. Elapsed: 0.116 sec.
</code></pre>
<p>Check if data is updated:</p>
<pre><code class="language-sql">SELECT *
FROM t_all
GROUP BY (timestamp, log, path)

Query id: 1cc2811e-cdb1-4fc2-b94e-6d9d4320ede8

┌───────────timestamp─┬─log──────────────────┬─path────────────────┐
│ 2023-10-17 10:30:00 │ Second log entry     │ /var/logs/file2.log │
│ 2023-10-17 12:15:00 │ Third log entry      │ /var/logs/file3.log │
│ 2023-10-18 12:15:00 │ Third log entry      │ /var/logs/file3.log │
│ 2023-10-17 09:00:00 │ Updated log entry &lt;- │ /var/logs/file1.log │
│ 2023-10-18 10:30:00 │ Second log entry     │ /var/logs/file2.log │
│ 2023-10-18 09:00:00 │ First log entry      │ /var/logs/file1.log │
└─────────────────────┴──────────────────────┴─────────────────────┘

6 rows in set. Elapsed: 0.007 sec.
</code></pre>
<p>We can see the record with timestamp <code>2023-10-17 09:00:00</code> is updated!</p>
<h1 id="refs-1"><a class="header" href="#refs-1">Refs</a></h1>
<p>https://clickhouse.com/docs/en/guides/developer/mutations</p>
<pre><code class="language-sql">ALTER TABLE website.clicks
UPDATE url = substring(url, position(url, '://') + 3), visitor_id = new_visit_id
WHERE visit_date &lt; '2022-01-01'
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="existing-value-not-exist-when-searching-log-in-kibana"><a class="header" href="#existing-value-not-exist-when-searching-log-in-kibana">Existing value not exist when searching log in kibana</a></h1>
<!-- toc -->
<ul>
<li><a href="elasticsearch/kibana/existing-value-not-exists-when-searching.html#existing-value-not-exist">Existing value not exist</a></li>
<li><a href="elasticsearch/kibana/existing-value-not-exists-when-searching.html#ingest-data">Ingest data</a></li>
<li><a href="elasticsearch/kibana/existing-value-not-exists-when-searching.html#search-using-filter">Search using filter</a></li>
<li><a href="elasticsearch/kibana/existing-value-not-exists-when-searching.html#reason-why-existing-data-not-exist">Reason why existing data not exist</a></li>
<li><a href="elasticsearch/kibana/existing-value-not-exists-when-searching.html#conclution">Conclution</a></li>
<li><a href="elasticsearch/kibana/existing-value-not-exists-when-searching.html#refs">refs</a></li>
</ul>
<!-- tocstop -->
<p>Recently, when searching for application error logs in Kibana, I encountered a particularly intriguing challenge. Some of the expected search results were missing, when using <code>error</code> as filter field and <code>exists</code> as filter operator in kibana(Click <code>+Add Filter</code> button). After scratching my head for a while and doing a deep dive into why this was happening, I stumbled upon a lifesaver feature in Elasticsearch - the <code>ignore_above</code> parameter.</p>
<p>Below are the samples for <code>error</code> field in log records.</p>
<pre><code class="language-json">[
  "你所在的区域无法查看特定的内容，请联系相关部门进行处理",
  "author is not authenticated missing parameters in request, request=id_is:Kp3mE5QJwVHkM1Wl3xCg client_id_is:MoNRe2Qxvz4nR8R9oZtA payment_number:\"jXb9q8flSY6vQIpV3GtE\" order_detail_id:L3R9mU1W8pN9gKuH6Wz deliver_timestamp:{seconds:QG4cP2a0QK6SxI6D0EbR} resp=internal_code:INTERNAL_CODE_PAYMENT_NOT_FOUND result_description:\"INTERNAL_CODE_PAYMENT_NOT_FOUND\"",
  "author is not authenticated missing parameters in request, request=user_id_is:T7L3b4HnE1pM6L9QeXy5 client_id_is:w1L6i0uJ3S0A9X6K4G5 payment_number:\"K0l6W0kR2rH9Y0O5Z0x8\" order_detail_id:J2A0B1Z4uE9X7Y2W7L0E deliver_timestamp:{seconds:1I3lC6nT8Q4N7j0X4I6v} resp=internal_code:INTERNAL_CODE_PAYMENT_NOT_FOUND result_description:\"INTERNAL_CODE_PAYMENT_NOT_FOUND\"",
  "author is not authenticated missing parameters in request, request=user_id_is:G5B9kS6pJ3C7H0D8K6M4 client_id_is:w9R0V6mF3A8D4H1G2G6 payment_number:\"Z3R0b8D7uJ2Z4Q5W7X6E\" order_detail_id:Y7T2R8X1vI6E0G3C7M3E deliver_timestamp:{seconds:4K6G9O5N3fP1K6S7R8Y} resp=internal_code:INTERNAL_CODE_PAYMENT_NOT_FOUND result_description:\"INTERNAL_CODE_PAYMENT_NOT_FOUND\"",
  "author is not authenticated missing parameters in request, request=user_id_is:U8T0D9hE8C3L6H9K5V7 client_id_is:O4xH2L3K5R0C9X2O9M0 merchant_id_iss:z5fN6qO0R4eV9tK8E2bB payment_number:\"D9H4fQ2O5W3C7R8E2C6\" order_detail_id:W8sI5kQ2dP3W1C7G9T5 deliver_timestamp:{seconds:R0U7X1Q3U5sE2Y4O8D} resp=internal_code:INTERNAL_CODE_PAYMENT_NOT_FOUND result_description:\"INTERNAL_CODE_PAYMENT_NOT_FOUND\""
]
</code></pre>
<p>The question is: Why doesn't the error log saying "author is not ..." appear in the search results?</p>
<h1 id="ingest-data"><a class="header" href="#ingest-data">Ingest data</a></h1>
<p>Now, let's do some investigation!</p>
<p>First, we creates an index named <code>tmp-1</code> with a single field called <code>error</code>. The <code>error</code> field is of type <code>text</code> for full-text search and has a sub-field named <code>keyword</code> of type <code>keyword</code> for exact matching, with a maximum length of <code>20</code> characters.</p>
<pre><code class="language-json">PUT /tmp-1
{
  "mappings": {
    "properties": {
      "error": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 20
          }
        }
      }
    }
  }
}
</code></pre>
<p>Then, we ingest some data to this index:</p>
<pre><code class="language-json">PUT /tmp-1/_doc/1
{
  "error": "This is a test.",
  "@timestamp": "2024-02-05T12:35:35Z"
}

PUT /tmp-1/_doc/2
{
  "error": "12345678901234567890",
  "@timestamp": "2024-02-05T12:35:35Z"

}

PUT /tmp-1/_doc/3
{
  "error": "12345678901234567890X",
  "@timestamp": "2024-02-05T12:35:35Z"

}
</code></pre>
<p>Notice, for doc three, the length of error field is longer than 20, which will cause problem when filtering doc in kibana.</p>
<h1 id="search-using-filter"><a class="header" href="#search-using-filter">Search using filter</a></h1>
<p>First, let's search with <code>error.keyword</code> exist(doc 3 is missing):</p>
<p><img src="https://raw.githubusercontent.com/lichuan6/i/main/es/Screenshot%202024-02-05%20at%2020.48.52.png" alt="Search with error.keyword exist" /></p>
<p>Let's see what is the result when searching with <code>error exist</code>(all docs are searchable):</p>
<p><img src="https://github.com/lichuan6/i/blob/main/es/Screenshot%202024-02-05%20at%2020.49.15.png?raw=true" alt="Search with error exist" /></p>
<h1 id="reason-why-existing-data-not-exist"><a class="header" href="#reason-why-existing-data-not-exist">Reason why existing data not exist</a></h1>
<p>In Elasticsearch, <code>ignore_above</code> is a parameter that can be used in the mapping of string fields, specifically for keyword types. The role of this parameter is to <strong>ignore</strong> (i.e., not index) any string which length is above the specified number of characters.</p>
<p>Let's consider an example:</p>
<pre><code class="language-json">"mappings": {
  "properties": {
    "name": {
      "type": "keyword",
      "ignore_above": 20
    }
  }
}
</code></pre>
<p>In the above mapping, any <code>name</code> field that has more than <code>20</code> characters will not be indexed and therefore, will not be <strong>searchable</strong>.</p>
<p>It's important to note that the <code>ignore_above</code> only influences the indexing process and not the <code>_source</code> field (<code>_source</code>), which means the value of the field remains untouched when returned from a query.</p>
<p>As for how it affects search results:</p>
<p>If you depend on a keyword search for a specific field and that field's length exceeds the <code>ignore_above</code> value, you <strong>won't</strong> retrieve any information regarding that field in your search results because Elasticsearch didn't index it.</p>
<p>This feature is especially useful for preventing huge keywords from being indexed (e.g., when a text field is mistakenly indexed as a keyword), effectively <strong>saving disk space</strong> in your Elasticsearch cluster.</p>
<h1 id="conclution"><a class="header" href="#conclution">Conclution</a></h1>
<p>The conclusion is, Elasticsearch's <code>ignore_above</code> parameter is beneficial when you want to prevent the indexing of excessively long keywords. This can effectively save storage space in your Elasticsearch cluster. However, you need to be aware that if a field's length exceeds the <code>ignore_above</code> value, it <strong>won't be indexed</strong> and, therefore, you <strong>won't be able to search</strong> for it in your search results - even though it will still exist in the <code>_source</code> field. It's crucial to set the <code>ignore_above</code> parameter carefully, considering the nature and requirements of your data and searches.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
