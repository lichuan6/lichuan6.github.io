<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Blog by lichuan</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">React</li><li class="chapter-item expanded affix "><li class="part-title">Functional Component</li><li class="chapter-item expanded "><a href="react/chartjs/render-all-chartjs-charts.html"><strong aria-hidden="true">1.</strong> Render all chartjs charts in react typescript tailwindcss projects</a></li><li class="chapter-item expanded affix "><li class="part-title">Gitlab</li><li class="chapter-item expanded "><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html"><strong aria-hidden="true">2.</strong> Register gitlab runner on Amazon Linux 2</a></li><li class="chapter-item expanded affix "><li class="part-title">Rust</li><li class="chapter-item expanded "><a href="rust/error/how-to-organise-application-error-in-actix-web-application.html"><strong aria-hidden="true">3.</strong> How to organise application Error in actix-web application</a></li><li class="chapter-item expanded affix "><li class="part-title">Go</li><li class="chapter-item expanded "><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html"><strong aria-hidden="true">4.</strong> Add dependency in go mod in self-hosted gitlab</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Blog by lichuan</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="render-all-chartjs-charts-in-react-typescript-tailwindcss-projects"><a class="header" href="#render-all-chartjs-charts-in-react-typescript-tailwindcss-projects">Render all chartjs charts in react typescript tailwindcss projects</a></h1>
<p>In this tutorial, we'll show you how to render all chartjs charts in React project.</p>
<h1 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h1>
<!--ts-->
<ul>
<li><a href="react/chartjs/render-all-chartjs-charts.html#render-all-chartjs-charts-in-react-typescript-tailwindcss-projects">Render all chartjs charts in react typescript tailwindcss projects</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#table-of-contents">Table of Contents</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#demoseeing-is-believing">Demo(seeing is believing)</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#start-nextjs-project">Start NextJS Project</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#define-all-chartjs-charts">Define all chartjs charts</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#write-a-functional-component">Write a functional component</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#write-a-chartjs-wrapper">Write a chartjs wrapper</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#layout">Layout</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#optimize">Optimize</a></li>
<li><a href="react/chartjs/render-all-chartjs-charts.html#summary">Summary</a></li>
</ul>
<!--te-->
<h1 id="demoseeing-is-believing"><a class="header" href="#demoseeing-is-believing">Demo(seeing is believing)</a></h1>
<p>Before diving in, we will show you all charts I created.</p>
<p><img src="https://user-images.githubusercontent.com/74223747/224673738-9edb7c6d-5e49-44a2-9bb0-00fa9eb5f608.png" alt="chartjs-react-chartjs-2-nextjs-tailwind-typescript-using-grid" /></p>
<h1 id="start-nextjs-project"><a class="header" href="#start-nextjs-project">Start NextJS Project</a></h1>
<p>First, we'll create a nextjs + tailwind + typescript project using <code>npx</code>:</p>
<pre><code class="language-bash">npx create-next-app@latest react-chartjs-2-nextjs-tailwind-example --typescript --eslint

cd react-chartjs-2-nextjs-tailwind-example
npm install -D tailwindcss postcss autoprefixer
npx tailwindcss init -p
</code></pre>
<h1 id="define-all-chartjs-charts"><a class="header" href="#define-all-chartjs-charts">Define all chartjs charts</a></h1>
<p>We copy all chartjs official example codes and put them in <code>component/chartjsofficial</code> directory. We also define title and component for each example chart. The <code>components</code> array is the chart data we will render later.</p>
<pre><code class="language-jsx">import { VerticalBarChart } from &quot;@/component/chartjsofficial/verticalbarchart&quot;;
import { HorizontalBarChart } from &quot;@/component/chartjsofficial/horizontalbarchart&quot;;
import { StackedBarChart } from &quot;@/component/chartjsofficial/stackedbarchart&quot;;
import { GroupedBarChart } from &quot;@/component/chartjsofficial/groupedbarchart&quot;;
import { AreaChart } from &quot;@/component/chartjsofficial/areachart&quot;;
import { LineChart } from &quot;@/component/chartjsofficial/linechart&quot;;
import { MultiAxisLineChart } from &quot;@/component/chartjsofficial/multiaxislinechart&quot;;
import { PieChart } from &quot;@/component/chartjsofficial/piechart&quot;;
import { DoughnutChart } from &quot;@/component/chartjsofficial/doughnutchart&quot;;
import { PolarAreaChart } from &quot;@/component/chartjsofficial/polarareachart&quot;;
import { RadarChart } from &quot;@/component/chartjsofficial/radarchart&quot;;
import { ScatterChart } from &quot;@/component/chartjsofficial/scatterchart&quot;;
import { BubbleChart } from &quot;@/component/chartjsofficial/bubblechart&quot;;
import { MultiTypeChart } from &quot;@/component/chartjsofficial/multitypechart&quot;;
import { ChartEvents } from &quot;@/component/chartjsofficial/chartevents&quot;;
import { ChartRef } from &quot;@/component/chartjsofficial/chartref&quot;;
import { GradientChart } from &quot;@/component/chartjsofficial/gradientchart&quot;;
import { ChartEventsSingleDataset } from &quot;@/component/chartjsofficial/charteventssingledataset&quot;;
import { ChartEventsSingleDatasetOutsideDatasource } from &quot;@/component/chartjsofficial/charteventssingledatasetoutsidedatasource&quot;;

const components = [
  {
    title: &quot;VerticalBarChart&quot;,
    component: VerticalBarChart,
  },
  {
    title: &quot;HorizontalBarChart&quot;,
    component: HorizontalBarChart,
  },
  {
    title: &quot;StackedBarChart&quot;,
    component: StackedBarChart,
  },
  {
    title: &quot;GroupedBarChart&quot;,
    component: GroupedBarChart,
  },
  {
    title: &quot;AreaChart&quot;,
    component: AreaChart,
  },
  {
    title: &quot;LineChart&quot;,
    component: LineChart,
  },
  {
    title: &quot;MultiAxisLineChart&quot;,
    component: MultiAxisLineChart,
  },
  {
    title: &quot;DoughnutChart&quot;,
    component: DoughnutChart,
  },
  {
    title: &quot;PolarAreaChart&quot;,
    component: PolarAreaChart,
  },
  {
    title: &quot;RadarChart&quot;,
    component: RadarChart,
  },
  {
    title: &quot;ScatterChart&quot;,
    component: ScatterChart,
  },
  {
    title: &quot;BubbleChart&quot;,
    component: BubbleChart,
  },
  {
    title: &quot;ScatterChart&quot;,
    component: ScatterChart,
  },
  {
    title: &quot;MultiTypeChart&quot;,
    component: MultiTypeChart,
  },
  {
    title: &quot;ChartEvents&quot;,
    component: ChartEvents,
  },
  {
    title: &quot;ChartRef&quot;,
    component: ChartRef,
  },
  {
    title: &quot;GradientChart&quot;,
    component: GradientChart,
  },
  {
    title: &quot;ChartEventsSingleDataset&quot;,
    component: ChartEventsSingleDataset,
  },
];
</code></pre>
<h1 id="write-a-functional-component"><a class="header" href="#write-a-functional-component">Write a functional component</a></h1>
<p>In order to render all components(charts), we write a functional component called <code>ComponentWrapper</code> to take array of components with title and render them in one place.</p>
<pre><code class="language-jsx">type Component = {
  title: string,
  component: React.FunctionComponent,
};
type ChartProps = {
  components: Component[],
};

const ComponentWrapper: React.FC&lt;ChartProps&gt; = ({ components }) =&gt; {
  return (
    &lt;div&gt;
      {components.map((component, index) =&gt; {
        return (
          &lt;ChartWrapper key={index} title={component.title}&gt;
            &lt;component.component /&gt;
          &lt;/ChartWrapper&gt;
        );
      })}
    &lt;/div&gt;
  );
};
</code></pre>
<p>The <code>ComponentWrapper</code> component maps over the components array and renders each component wrapped in a <code>ChartWrapper</code> component(explained later).</p>
<p>It receives a prop object of type <code>ChartProps</code>, destructures the <code>components</code> property from that object, and uses it to render a list of React function components.</p>
<p>We can refer to the component part from item in <code>components</code> array, i.e. <code>ChartEventsSingleDataset</code></p>
<pre><code class="language-jsx">import React, { MouseEvent, useRef } from &quot;react&quot;;
import type { InteractionItem } from &quot;chart.js&quot;;
import {
  Chart as ChartJS,
  LinearScale,
  CategoryScale,
  BarElement,
  PointElement,
  LineElement,
  Legend,
  Tooltip,
} from &quot;chart.js&quot;;
import {
  Chart,
  getDatasetAtEvent,
  getElementAtEvent,
  getElementsAtEvent,
} from &quot;react-chartjs-2&quot;;
import faker from &quot;faker&quot;;

ChartJS.register(
  LinearScale,
  CategoryScale,
  BarElement,
  PointElement,
  LineElement,
  Legend,
  Tooltip
);

export const options = {
  scales: {
    y: {
      beginAtZero: true,
    },
  },
};

const labels = [&quot;January&quot;, &quot;February&quot;, &quot;March&quot;, &quot;April&quot;, &quot;May&quot;, &quot;June&quot;, &quot;July&quot;];

export const data = {
  labels,
  datasets: [
    {
      type: &quot;bar&quot; as const,
      label: &quot;Dataset 1&quot;,
      borderColor: &quot;rgb(255, 99, 132)&quot;,
      backgroundColor: &quot;rgb(255, 99, 132)&quot;,
      data: labels.map(() =&gt; faker.datatype.number({ min: -1000, max: 1000 })),
    },
  ],
};

export function ChartEventsSingleDataset() {
  const printDatasetAtEvent = (dataset: InteractionItem[]) =&gt; {
    if (!dataset.length) return;

    const datasetIndex = dataset[0].datasetIndex;

    console.log(`printDatasetAtEvent: ${data.datasets[datasetIndex].label}`);
  };

  const printElementAtEvent = (element: InteractionItem[]) =&gt; {
    if (!element.length) return;

    const { datasetIndex, index } = element[0];

    console.log(
      `index: ${data.labels[index]}, data: ${data.datasets[datasetIndex].data[index]}`
    );
  };

  const printElementsAtEvent = (elements: InteractionItem[]) =&gt; {
    if (!elements.length) return;

    console.log(`element length: ${elements.length}`);
  };

  const chartRef = useRef&lt;ChartJS&gt;(null);

  const onClick = (event: MouseEvent&lt;HTMLCanvasElement&gt;) =&gt; {
    const { current: chart } = chartRef;

    if (!chart) {
      return;
    }

    printDatasetAtEvent(getDatasetAtEvent(chart, event));
    printElementAtEvent(getElementAtEvent(chart, event));
    printElementsAtEvent(getElementsAtEvent(chart, event));
  };

  return (
    &lt;Chart
      ref={chartRef}
      type=&quot;bar&quot;
      onClick={onClick}
      options={options}
      data={data}
    /&gt;
  );
}
</code></pre>
<h1 id="write-a-chartjs-wrapper"><a class="header" href="#write-a-chartjs-wrapper">Write a chartjs wrapper</a></h1>
<p>In order to add title for each chart, we write a functional component to wrapper up every chart with a <code>h1</code>. Note we define the <code>h1</code> style using tailwindcss, setting div size(<code>h-96</code>) and text size(<code>text-3xl</code>), etc.</p>
<pre><code class="language-jsx">export const ChartWrapper: React.FC&lt;{
  title: string,
  children: React.ReactNode,
}&gt; = ({ title, children }) =&gt; {
  return (
    &lt;div className=&quot;max-h-96 h-96  bg-slate-50 border border-dashed&quot;&gt;
      &lt;h1 className=&quot;text-3xl text-center font-bold underline&quot;&gt;{title}&lt;/h1&gt;
      {children}
    &lt;/div&gt;
  );
};
</code></pre>
<p>The <code>ChartWrapper</code> is also a functional component that renders <code>title</code> in <code>h1</code> tag and <code>children</code> property below it.</p>
<p>All other chartjs components are straightforward.</p>
<h1 id="layout"><a class="header" href="#layout">Layout</a></h1>
<p>Now, we need to define the layout of all charts. We can use <code>grid</code> layout from tailwind and put all charts into it.</p>
<p>In <code>App</code> component, we iterate the components and render them in a div with <code>grid</code> class.</p>
<pre><code class="language-jsx">export default function App() {
  return (
    &lt;div&gt;
      &lt;Head&gt;
        &lt;title&gt;ChartJS + NextJS + TailwindCSS&lt;/title&gt;
        &lt;meta name=&quot;description&quot; content=&quot;Generated by create next app&quot; /&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
        &lt;link rel=&quot;icon&quot; href=&quot;/favicon.ico&quot; /&gt;
      &lt;/Head&gt;
      &lt;main className={styles.main}&gt;
        &lt;div className={styles.description}&gt;
          &lt;h1 className=&quot;text-3xl text-center font-bold underline&quot;&gt;
            ChartJS + NextJS + TailwindCSS
          &lt;/h1&gt;
          &lt;div className=&quot;container columns-2&quot;&gt;
            &lt;div className=&quot;grid grid-cols-2 md:grid-cols-1 gap-0&quot;&gt;
              {&lt;ComponentWrapper components={components} /&gt;}
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/main&gt;
    &lt;/div&gt;
  );
}
</code></pre>
<p>This is a React component called App that is exporting as a default. The component renders a main <code>div</code> element that contains a <code>Head</code> component and a main element with a className of <code>styles.main</code>. Within the main element, there is a div element with a <code>className</code> of <code>styles.description</code> that contains a <code>h1</code> element with a <code>className</code> of <code>&quot;text-3xl text-center font-bold underline&quot;</code> and some text.</p>
<p>The div element also contains a div element with a <code>className</code> of <code>&quot;container columns-2&quot;</code> that contains an inner div element with a className of <code>&quot;grid grid-cols-2 md:grid-cols-1 gap-0&quot;</code>. This inner div element renders the <code>ComponentWrapper</code> component passing an array of components in the components prop.</p>
<p>Here is the important part:</p>
<pre><code class="language-jsx">{
  &lt;ComponentWrapper components={components} /&gt;;
}
</code></pre>
<p>The <code>ComponentWrapper</code> component dynamically renders each component passed in the <code>components</code> array. The rendering of each component is wrapped in a <code>ChartWrapper</code> component that provides a title for each component.</p>
<h1 id="optimize"><a class="header" href="#optimize">Optimize</a></h1>
<p>Can we do better? The answer is yes!</p>
<p>Notice, for <code>ComponentWrapper</code> function component, it's more verbose. We could write it in another way.</p>
<p>Here is the old way.</p>
<pre><code class="language-jsx">// NOTE: OK but verbose
const ComponentWrapper: React.FC&lt;ChartProps&gt; = ({ components }) =&gt; {
  return (
    &lt;div&gt;
      {components.map((c, index) =&gt; {
        return (
          &lt;ChartWrapper key={index} title={c.title}&gt;
            &lt;c.component /&gt;
          &lt;/ChartWrapper&gt;
        );
      })}
    &lt;/div&gt;
  );
};
</code></pre>
<p>The new way:</p>
<pre><code class="language-jsx">// NOTE: concise
const ComponentWrapperNew: React.FC&lt;ChartProps&gt; = ({ components }) =&gt; {
  return (
    &lt;div&gt;
      {components.map((c, index) =&gt; {
        const { title, component: C } = c;

        return (
          &lt;ChartWrapper key={index} title={title}&gt;
            &lt;C /&gt;
          &lt;/ChartWrapper&gt;
        );
      })}
    &lt;/div&gt;
  );
};
</code></pre>
<p>To render list of charts components with titles and properties, we wrote two React component functions. Although both functions produce the same output, their implementation approaches are different.</p>
<p>The first function <code>ComponentWrapper</code> is a good method, but the downside is that it is quite verbose. It uses curly braces and a return statement to wrap the component inside <code>&lt;ChartWrapper&gt;</code>, and it also references <code>c.title</code> and <code>c.component</code> multiple times within the function body.</p>
<p>The second function <code>ComponentWrapperNew</code> is a more concise implementation. It uses ES6 destructuring syntax to get <code>title</code> and <code>component</code> from the <code>components</code> object, which avoids repeated use of <code>c.title</code> and <code>c.component</code>. Additionally, it uses a more descriptive variable name <code>C</code> for the component. We can also call it <code>ChartComponent</code> if you like.</p>
<p>Clearly, the second implementation is more succinct, easier to read and maintain, and also makes it easier to add new properties or methods. Therefore, we recommend using the second function <code>ComponentWrapperNew</code> as a more efficient programming practice.</p>
<p>To summarize, the primary difference between these two implementation methods is that the first one is verbose, which makes it difficult to read and maintain, while the second one is more concise and easier to read and maintain. The second function also uses destructuring, which is a useful syntax for improving readability by eliminating repetition. By using a more concise and readable implementation, you can streamline your code and make it more efficient.</p>
<h1 id="summary"><a class="header" href="#summary">Summary</a></h1>
<p>In this post, we compare and contrast two React component functions that are used to render a list of chart components with titles and properties. While both functions ultimately produce the same result, their implementation approaches are different.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="register-gitlab-runner-on-amazon-linux-2"><a class="header" href="#register-gitlab-runner-on-amazon-linux-2">Register gitlab runner on Amazon Linux 2</a></h1>
<h1 id="table-of-contents-1"><a class="header" href="#table-of-contents-1">Table of Contents</a></h1>
<!--ts-->
<ul>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#register-gitlab-runner-on-amazon-linux-2">Register gitlab runner on Amazon Linux 2</a></li>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#start-aws-ec2-instance">Start AWS EC2 Instance</a></li>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#install-gitlab-runner-on-amazon-linux-2">Install gitlab runner on Amazon Linux 2</a></li>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#register-gitlab-runner">Register gitlab runner</a></li>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#set-gitlab_port-to-443">Set GITLAB_PORT to 443</a></li>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#write-gitlab-ciyml-for-go-project">Write .gitlab-ci.yml for go project</a></li>
<li><a href="gitlab/runner/register-gitlab-runner-on-amazon-linux-2.html#test-the-runner">Test the runner</a></li>
</ul>
<!--te-->
<h1 id="start-aws-ec2-instance"><a class="header" href="#start-aws-ec2-instance">Start AWS EC2 Instance</a></h1>
<p>You can create aws ec2 instance either in aws console or using aws cli.</p>
<p>Notice you should enable public ip address if your ec2 instance is in public subnet of you VPC, otherwise you will not be able to access the internet!</p>
<h1 id="install-gitlab-runner-on-amazon-linux-2"><a class="header" href="#install-gitlab-runner-on-amazon-linux-2">Install gitlab runner on Amazon Linux 2</a></h1>
<p>Next, we'll install gitlab runner on Amazon Linux 2. Run the following bash script:</p>
<pre><code class="language-bash"># install on amazon linux 2
# refs: https://github.com/beda-software/FAQ/blob/master/aws-ec2-gitlab-runner.md
curl -L &quot;https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh&quot; | sudo bash
sudo -E yum install gitlab-runner
sudo amazon-linux-extras install docker
sudo service docker start
sudo usermod -a -G docker ec2-user
sudo systemctl enable docker.service
sudo systemctl enable containerd.service
sudo usermod -a -G docker ec2-user
sudo yum install -y git
</code></pre>
<h1 id="register-gitlab-runner"><a class="header" href="#register-gitlab-runner">Register gitlab runner</a></h1>
<p>You can register gitlab runner by using <code>gitlab-ci-multi-runner</code> command:</p>
<pre><code class="language-bash"># register runner
# sudo gitlab-ci-multi-runner register -n --url GITLAB_URL --registration-token &quot;TOKEN&quot;   --executor docker   --description &quot;Name of docker runner&quot;   --docker-image &quot;docker:latest&quot; --docker-privileged
</code></pre>
<p>Replace <code>GITLAB_URL</code> and <code>TOKEN</code> with your self-hosted gitlab url or token. You can go to <code>https://gitlab.mycompany.com/admin/runners</code> and click <code>Register an instance runner</code> button, and you will see the <code>TOKEN</code> in the popup.</p>
<pre><code class="language-bash"># register runner in gitlab
sudo gitlab-ci-multi-runner register -n --url https://gitlab.mycompany.com/ --registration-token &quot;A____TOKEN_____A&quot;   --executor docker   --description &quot;Name of docker runner&quot;   --docker-image &quot;docker:latest&quot; --docker-privileged
</code></pre>
<p>Output:</p>
<pre><code>Runtime platform                                    arch=amd64 os=linux pid=8095 revision=865283c5 version=16.1.0
Running in system-mode.

WARNING: Support for registration tokens and runner parameters in the 'register' command has been deprecated in GitLab Runner 15.6 and will be replaced with support for authentication tokens. For more information, see https://gitlab.com/gitlab-org/gitlab/-/issues/380872
Registering runner... succeeded                     runner=paaaaaaa
Runner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded!

Configuration (with the authentication token) was saved in &quot;/etc/gitlab-runner/config.toml&quot;
</code></pre>
<p>You will see a runner with name <code>paaaaaaa</code> is registered successfully.</p>
<p>And you can also config the runner in <code>/etc/gitlab-runner/config.toml</code>.</p>
<p>You can go to runners page in gitlab Admin and check if the runner is registered successfully.</p>
<p><img src="https://github.com/lichuan6/lichuan6.github.io/assets/74223747/c4df4b54-ae28-40e2-be29-66a29b2206f1" alt="Runner" /></p>
<h1 id="set-gitlab_port-to-443"><a class="header" href="#set-gitlab_port-to-443">Set GITLAB_PORT to 443</a></h1>
<p>As the runner is registered successfully, you may encounter an error like this:</p>
<pre><code>gitlab-runner version 14.10.1 fails to clone a repo configured with a https repo URL, stating HTTP Basic: Access denied.
</code></pre>
<p>As we deploy gitlab using <code>https://github.com/sameersbn/docker-gitlab</code>, you may need to set <code>GITLAB_PORT</code> to <code>443</code> based on your configuration for load balancer above gitlab service, or add <code>clone_url</code> to the runner config file <code>/etc/gitlab-runner/config.toml</code>. Also, don't forget to restart docker servcie <code>sudo sercie docker restart</code>.</p>
<pre><code class="language-toml">concurrent = 1
check_interval = 0
shutdown_timeout = 0

[session_server]
  session_timeout = 1800

[[runners]]
  name = &quot;Name of docker runner&quot;
  url = &quot;https://gitlab.mycompany.com/&quot;
  clone_url = &quot;https://gitlab.mycompany.com/&quot;
  id = 1
  token = &quot;s_____________n&quot;
  token_obtained_at = 2023-07-22T01:20:41Z
  token_expires_at = 0001-01-01T00:00:00Z
  executor = &quot;docker&quot;
  [runners.cache]
    MaxUploadedArchiveSize = 0
  [runners.docker]
    tls_verify = false
    image = &quot;docker:latest&quot;
    privileged = true
    disable_entrypoint_overwrite = false
    oom_kill_disable = false
    disable_cache = false
    volumes = [&quot;/cache&quot;]
    shm_size = 0
</code></pre>
<h1 id="write-gitlab-ciyml-for-go-project"><a class="header" href="#write-gitlab-ciyml-for-go-project">Write .gitlab-ci.yml for go project</a></h1>
<p>For go project, you can write a gitlab ci file and test the runner.</p>
<p>Here is a simple gitlab ci file:</p>
<pre><code class="language-yaml"># You can copy and paste this template into a new `.gitlab-ci.yml` file.
# You should not add this template to an existing `.gitlab-ci.yml` file by using the `include:` keyword.
#
# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html
# This specific template is located at:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Go.gitlab-ci.yml

image: golang:latest

stages:
  - test
  - build
  - deploy

format:
  stage: test
  script:
    - go fmt $(go list ./... | grep -v /vendor/)
    - go vet $(go list ./... | grep -v /vendor/)
    - go test -race $(go list ./... | grep -v /vendor/)

compile:
  stage: build
  script:
    - mkdir -p mybinaries
    - go build -o mybinaries ./...
  artifacts:
    paths:
      - mybinaries

deploy:
  stage: deploy
  script: echo &quot;Define your deployment script!&quot;
  environment: production
</code></pre>
<h1 id="test-the-runner"><a class="header" href="#test-the-runner">Test the runner</a></h1>
<p>You can trigger ci either by committing on <code>main</code> branch or clicking <code>Run Pipeline</code> in your project's pipeline page, i.e https://gitlab.mycompany.com/myname/go-ci-test/-/pipelines</p>
<p>If the pipeline is passed, your gitlab runner is runner successfully.</p>
<p><img src="https://github.com/lichuan6/lichuan6.github.io/assets/74223747/aaf5c27f-7451-4061-a0f6-181250f4abb0" alt="Pipeline" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-organise-application-error-in-actix-web-application"><a class="header" href="#how-to-organise-application-error-in-actix-web-application">How to organise application Error in actix-web application</a></h1>
<h1 id="table-of-contents-2"><a class="header" href="#table-of-contents-2">Table of Contents</a></h1>
<!--ts-->
<ul>
<li><a href="rust/error/how-to-organise-application-error-in-actix-web-application.html#how-to-organise-application-error-in-actix-web-application">How to organise application Error in actix-web application</a></li>
<li><a href="rust/error/how-to-organise-application-error-in-actix-web-application.html#dao-layer">Dao layer</a></li>
<li><a href="rust/error/how-to-organise-application-error-in-actix-web-application.html#actix-web-http-layer">Actix-web http layer</a></li>
<li><a href="rust/error/how-to-organise-application-error-in-actix-web-application.html#solution">Solution</a></li>
</ul>
<!--te-->
<h1 id="dao-layer"><a class="header" href="#dao-layer">Dao layer</a></h1>
<p>For dao layer, usually we use <code>lib::Result</code> as return type. Below is an example of fetching all users when using <code>clickhosue-rs</code> crate:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use clickhouse::error::{Error, Result};

pub async fn get_all_users(client: &amp;Client) -&gt; Result&lt;Vec&lt;User&gt;&gt; {
    let users = client
        .query(&quot;SELECT ?fields FROM users&quot;)
        .fetch_all::&lt;User&gt;()
        .await?;

    Ok(users)
}
<span class="boring">}</span></code></pre></pre>
<p>Notice, the <code>Result</code> is not <code>std::result::Result</code> type, it is a type that use <code>clickhouse::error::Error</code> as the error type in <code>Result</code> generic type.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::{error::Error as StdError, fmt, io, result, str::Utf8Error};

use serde::{de, ser};

/// A result with a specified [`Error`] type.
pub type Result&lt;T, E = Error&gt; = result::Result&lt;T, E&gt;;


/// Represents all possible errors.
#[derive(Debug, thiserror::Error)]
#[non_exhaustive]
#[allow(missing_docs)]
pub enum Error {
    #[error(&quot;invalid params: {0}&quot;)]
    InvalidParams(#[source] Box&lt;dyn StdError + Send + Sync&gt;),
    #[error(&quot;network error: {0}&quot;)]
    Network(#[source] Box&lt;dyn StdError + Send + Sync&gt;),
    #[error(&quot;compression error: {0}&quot;)]
    Compression(#[source] Box&lt;dyn StdError + Send + Sync&gt;),
    #[error(&quot;decompression error: {0}&quot;)]
    Decompression(#[source] Box&lt;dyn StdError + Send + Sync&gt;),
    #[error(&quot;no rows returned by a query that expected to return at least one row&quot;)]
    RowNotFound,
    #[error(&quot;sequences must have a known size ahead of time&quot;)]
    SequenceMustHaveLength,
    #[error(&quot;`deserialize_any` is not supported&quot;)]
    DeserializeAnyNotSupported,
    #[error(&quot;not enough data, probably a row type mismatches a database schema&quot;)]
    NotEnoughData,
    #[error(&quot;string is not valid utf8&quot;)]
    InvalidUtf8Encoding(#[from] Utf8Error),
    #[error(&quot;tag for enum is not valid&quot;)]
    InvalidTagEncoding(usize),
    #[error(&quot;a custom error message from serde: {0}&quot;)]
    Custom(String),
    #[error(&quot;bad response: {0}&quot;)]
    BadResponse(String),
    #[error(&quot;timeout expired&quot;)]
    TimedOut,

    // Internally handled errors, not part of public API.
    // XXX: move to another error?
    #[error(&quot;internal error: too small buffer, need another {0} bytes&quot;)]
    #[doc(hidden)]
    TooSmallBuffer(usize),
}
<span class="boring">}</span></code></pre></pre>
<h1 id="actix-web-http-layer"><a class="header" href="#actix-web-http-layer">Actix-web http layer</a></h1>
<p>Actix-web framework requires the error type is <code>actix_web::error::Error</code> if <code>actix_web::Result</code> is used as the return type.</p>
<p><code>Result</code> type in actix-web :</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub use self::error::Error;
pub use self::internal::*;
pub use self::response_error::ResponseError;
pub(crate) use macros::{downcast_dyn, downcast_get_type_id};

/// A convenience [`Result`](std::result::Result) for Actix Web operations.
///
/// This type alias is generally used to avoid writing out `actix_http::Error` directly.
pub type Result&lt;T, E = Error&gt; = std::result::Result&lt;T, E&gt;;
<span class="boring">}</span></code></pre></pre>
<p><code>Error</code> type in actix-web :</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// General purpose Actix Web error.
///
/// An Actix Web error is used to carry errors from `std::error` through actix in a convenient way.
/// It can be created through converting errors with `into()`.
///
/// Whenever it is created from an external object a response error is created for it that can be
/// used to create an HTTP response from it this means that if you have access to an actix `Error`
/// you can always get a `ResponseError` reference from it.
pub struct Error {
    cause: Box&lt;dyn ResponseError&gt;,
}
<span class="boring">}</span></code></pre></pre>
<p>Normally, we write actix-web handler and call dao functions like this:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub async fn get_all_users(data: web::Data&lt;AppState&gt;) -&gt; actix_web::Result&lt;impl Responder&gt; {
    let db = &amp;data.db;

    // call dao function to fetch data
    let users = users::get_all_users(db).await?;
    Ok(web::Json(users))
}
<span class="boring">}</span></code></pre></pre>
<p>If you write a http handler like this and call function in dao(i.e. <code>dao::get_all_users</code>) function, which returns an error from the dao crate, error will happen.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>   --&gt; src/user/http.rs:348:54
    |
348 |     let users = users::get_all(db).await?;
    |                                         ^ the trait `ResponseError` is not implemented for `clickhouse::error::Error`
    |
    = help: the following other types implement trait `ResponseError`:
              AppError
              BlockingError
              Box&lt;(dyn StdError + 'static)&gt;
              HttpError
              Infallible
              InvalidHeaderValue
              JsonPayloadError
              PathError
            and 17 others
    = note: required for `actix_web::Error` to implement `std::convert::From&lt;clickhouse::error::Error&gt;`
    = note: required for `Result&lt;_, actix_web::Error&gt;` to implement `FromResidual&lt;Result&lt;Infallible, clickhouse::error::Error&gt;&gt;`
<span class="boring">}</span></code></pre></pre>
<p>It means that you cannot convert <code>clickhouse::error::Error</code> to <code>actix_web::Error</code>.</p>
<p>The reason is that the error type in dao function is <code>clickhouse::error::Error</code> and <code>actix_web::Error</code> in http handler. You have to implement <code>From</code> trait as rust compiler told you.</p>
<h1 id="solution"><a class="header" href="#solution">Solution</a></h1>
<p>One possible solution is to define application error and implement <code>From</code> trait, which will convert <code>clickhouse::error::Error</code> to <code>AppError</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Debug)]
pub enum AppError {
    ClickhouseError(ClickhouseError),
    // ... other error variants
}

impl ResponseError for AppError {
    fn error_response(&amp;self) -&gt; HttpResponse {
        HttpResponse::InternalServerError().body(self.to_string())
        // We can also use match to handle specific error define in clickhouse::error::Error
        // match *self {
        //     AppError::ClickhouseError(ref err) =&gt; match err {
        //         ClickhouseError::Timeout(err) =&gt; HttpResponse::InternalServerError()
        //             .body(format!(&quot;Clickhouse server error: {}&quot;, err)),
        //         ClickhouseError::Network(err) =&gt; {
        //             HttpResponse::BadRequest().body(format!(&quot;Clickhouse client error: {}&quot;, err))
        //         }
        //         _ =&gt; HttpResponse::InternalServerError().body(&quot;Unknown error&quot;),
        //     }, // ... handle other error variants
        // }
    }
}

use std::fmt;

impl fmt::Display for AppError {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter) -&gt; fmt::Result {
        match *self {
            AppError::ClickhouseError(ref err) =&gt; {
                write!(f, &quot;Clickhouse error: {}&quot;, err)
            } // ... handle other error variants
        }
    }
}

impl From&lt;ClickhouseError&gt; for AppError {
    fn from(error: ClickhouseError) -&gt; Self {
        AppError::ClickhouseError(error)
    }
}
<span class="boring">}</span></code></pre></pre>
<p>Finally, you need to modify actix-web handler:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use clickhouse::error::{Error, Result};

// Previous function signature
// pub async fn get_all_users(data: web::Data&lt;AppState&gt;) -&gt; actix_web::Result&lt;impl Responder&gt; {
// Pass AppError to handler's return type
pub async fn get_all_users(data: web::Data&lt;AppState&gt;) -&gt; actix_web::Result&lt;impl Responder, AppError&gt; {
    let db = &amp;data.db;

    // call dao function to fetch data
    let users = users::get_all_users(db).await?;
    Ok(web::Json(users))
}
<span class="boring">}</span></code></pre></pre>
<p>🎉🎉🎉</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="table-of-contents-3"><a class="header" href="#table-of-contents-3">Table of Contents</a></h1>
<!--ts-->
<ul>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#add-dependency-in-go-mod-in-self-hosted-gitlab">Add dependency in go mod in self-hosted gitlab</a>
<ul>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#background">Background</a></li>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#how-go-get-works">How go get works?</a></li>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#fix">Fix</a>
<ul>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#use-nginx">Use nginx</a></li>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#use-caddy">Use caddy</a></li>
</ul>
</li>
<li><a href="go/gomod/add-dependency-in-go-mod-in-self-hosted-gitlab.html#config-ssh">Config ssh</a></li>
</ul>
</li>
</ul>
<!--te-->
<h1 id="add-dependency-in-go-mod-in-self-hosted-gitlab"><a class="header" href="#add-dependency-in-go-mod-in-self-hosted-gitlab">Add dependency in go mod in self-hosted gitlab</a></h1>
<h2 id="background"><a class="header" href="#background">Background</a></h2>
<p>As a infrastructure engineer, it is common to deploy source code management tools like GitLab to management source code. When using GitLab for code management, we need to add dependencies to our projects like this:</p>
<pre><code class="language-bash">go get -u -v gitlab.mycompany.com/mygroup/myproject
</code></pre>
<p>If we're using github, running <code>go get github.com/username/repo</code> will succeed. Here is an example:</p>
<pre><code class="language-bash">go get -u -v github.com/lichuan6/go-mod-test
</code></pre>
<p>Output:</p>
<pre><code>go: downloading github.com/lichuan6/go-mod-test v1.0.1
go: added github.com/lichuan6/go-mod-test v1.0.1
</code></pre>
<p>However, it fails with self-hosted VCS like gitlab:</p>
<pre><code class="language-bash">go get gitlab.mycompany.com/mygroup/myproject
</code></pre>
<p>Output:</p>
<pre><code>go: unrecognized import path &quot;gitlab.mycompany.com/mygroup/myproject&quot;: parse https://gitlab.mycompany.com/mygroup/myproject?go-get=1: no go-import meta tags (meta tag gitlab.mycompany.com:443/mygroup/myproject did not match import path gitlab.mycompany.com/mygroup/myproject)
</code></pre>
<p>What does this error message mean?</p>
<h2 id="how-go-get-works"><a class="header" href="#how-go-get-works">How go get works?</a></h2>
<p>Before digging into the reason why it failds, we need to understand how <code>go get</code> works.</p>
<p>The <a href="https://docs.gitlab.com/ee/development/go_guide/dependencies.html">gitlab document</a> says that prior to Go 1.12, the process for fetching a package was as follows:</p>
<ul>
<li>Query <code>https://{package name}?go-get=1</code>.</li>
<li>Scan the response for the <code>go-import</code> meta tag.</li>
<li>Fetch the repository indicated by the meta tag using the indicated VCS.</li>
</ul>
<p>The meta tag should have the form <code>&lt;meta name=&quot;go-import&quot; content=&quot;{prefix} {vcs} {url}&quot;&gt;</code>. For example, <code>gitlab.com/my/project git https://gitlab.com/my/project.git</code> indicates that packages beginning with <code>gitlab.com/my/project</code> should be fetched from <code>https://gitlab.com/my/project.git</code> using Git.</p>
<p>Looking back the error message, we know that we do not config correct meta tag for request like <code>https://{package name}?go-get=1</code>, here it refers to <code>https://gitlab.mycompany.com/mygroup/myproject</code>.</p>
<h2 id="fix"><a class="header" href="#fix">Fix</a></h2>
<p>The fix is easy, but it maybe different depending on which reverse proxy you use.</p>
<h3 id="use-nginx"><a class="header" href="#use-nginx">Use nginx</a></h3>
<p>If you're using <code>nginx</code>, you can add the following config to nginx configuration:</p>
<pre><code>server {
    server_name gitlab.mycompany.com;

    if ($args ~* &quot;^go-get=1&quot;) {
      set $condition goget;
    }
    if ($uri ~ ^/([a-zA-Z0-9\._-]+)/([a-zA-Z0-9_-]+)/?.*$) {
      set $condition &quot;${condition}query&quot;;
    }
    if ($condition = gogetquery) {
      return 200 &quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta content='gitlab.mycompany.com/$1/$2 git https://gitlab.mycompany.com
/$1/$2' name='go-import'&gt;&lt;/head&gt;&lt;/html&gt;&quot;;
    }
}
</code></pre>
<h3 id="use-caddy"><a class="header" href="#use-caddy">Use caddy</a></h3>
<p>If you're using <code>caddy</code>, you can add the following config to <code>Caddyfile</code>:</p>
<pre><code>gitlab.mycompany.com {
        @goget {
                path_regexp goget ^/([a-zA-Z0-9\._-]+)/([a-zA-Z0-9_-]+)$
                query go-get=1
        }

        respond @goget 200 {
                body &quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta content='gitlab.mycompany.com/{re.goget.1}/{re.goget.2} git ssh://git@gitlab.mycompany.com/{re.goget.1}/{re.goget.2}' name='go-import'&gt;&lt;/head&gt;&lt;/html&gt;&quot;
        }

        reverse_proxy localhost:10080
}
</code></pre>
<h2 id="config-ssh"><a class="header" href="#config-ssh">Config ssh</a></h2>
<p>Now we have reverse proxy configured to return the correct meta tag in response, but there's still an error when running <code>go get -u -v gitlab.mycompany.com/mygroup/myproject</code>:</p>
<pre><code>get &quot;gitlab.mycompany.com/mygroup/myproject&quot;: found meta tag vcs.metaImport{Prefix:&quot;gitlab.mycompany.com/mygroup/myproject&quot;, VCS:&quot;git&quot;, RepoRoot:&quot;ssh://git@gitlab.mycompany.com/mygroup/myproject&quot;} at //gitlab.mycompany.com/mygroup/myproject?go-get=1
go: module gitlab.mycompany.com/mygroup/myproject: git ls-remote -q origin in /Users/username/go/pkg/mod/cache/vcs/d831e72abb0cb1006afb601471112319e0a1d0e490efb16e63a5682d76677a2e: exit status 128:
        Host key verification failed.
        fatal: Could not read from remote repository.

        Please make sure you have the correct access rights
        and the repository exists.
</code></pre>
<p>You need to add the following to ssh config file: <code>~/.ssh/config</code>, which means it wil tell go get to use the correct identity file to fetch the package from gitlab:</p>
<pre><code>Host gitlab.mycompany.com
    # ssh://git@gitlab.mycompany.com/username/project.git
    Port 10022
    User git
    #IdentityFile ~/.ssh/id_rsa.gitlab.self-hosted
    IdentityFile ~/.ssh/id_rsa-gitlab.self-hosted
</code></pre>
<p>After all is setup, you can add dependency using <code>go get</code> successfully.</p>
<pre><code>get &quot;gitlab.tencet.com/mygroup/myproject&quot;: found meta tag vcs.metaImport{Prefix:&quot;gitlab.mycompany.com/mygroup/myproject&quot;, VCS:&quot;git&quot;, RepoRoot:&quot;ssh://git@gitlab.mycompany.com/mygroup/myproject&quot;} at //gitlab.mycompany.com/mygroup/myproject?go-get=1
go: added gitlab.mycompany.com/mygroup/myproject v0.0.1
</code></pre>
<p>🎉🎉🎉</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
